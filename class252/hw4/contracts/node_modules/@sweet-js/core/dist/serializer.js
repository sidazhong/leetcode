"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.serializer = exports.makeDeserializer = undefined;

var _transitJs = require("transit-js");

var _transitJs2 = _interopRequireDefault(_transitJs);

var _immutable = require("immutable");

var _syntax = require("./syntax");

var _syntax2 = _interopRequireDefault(_syntax);

var _symbol = require("./symbol");

var _tokens = require("./tokens");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

let typeMap = [_tokens.TokenType.STRING, _tokens.TokenType.EOS, _tokens.TokenType.LPAREN, _tokens.TokenType.RPAREN, _tokens.TokenType.LBRACK, _tokens.TokenType.RBRACK, _tokens.TokenType.LBRACE, _tokens.TokenType.RBRACE, _tokens.TokenType.COLON, _tokens.TokenType.SEMICOLON, _tokens.TokenType.PERIOD, _tokens.TokenType.ELLIPSIS, _tokens.TokenType.ARROW, _tokens.TokenType.CONDITIONAL, _tokens.TokenType.INC, _tokens.TokenType.DEC, _tokens.TokenType.ASSIGN, _tokens.TokenType.ASSIGN_BIT_OR, _tokens.TokenType.ASSIGN_BIT_XOR, _tokens.TokenType.ASSIGN_BIT_AND, _tokens.TokenType.ASSIGN_SHL, _tokens.TokenType.ASSIGN_SHR, _tokens.TokenType.ASSIGN_SHR_UNSIGNED, _tokens.TokenType.ASSIGN_ADD, _tokens.TokenType.ASSIGN_SUB, _tokens.TokenType.ASSIGN_MUL, _tokens.TokenType.ASSIGN_DIV, _tokens.TokenType.ASSIGN_MOD, _tokens.TokenType.COMMA, _tokens.TokenType.OR, _tokens.TokenType.AND, _tokens.TokenType.BIT_OR, _tokens.TokenType.BIT_XOR, _tokens.TokenType.BIT_AND, _tokens.TokenType.SHL, _tokens.TokenType.SHR, _tokens.TokenType.SHR_UNSIGNED, _tokens.TokenType.ADD, _tokens.TokenType.SUB, _tokens.TokenType.MUL, _tokens.TokenType.DIV, _tokens.TokenType.MOD, _tokens.TokenType.EQ, _tokens.TokenType.NE, _tokens.TokenType.EQ_STRICT, _tokens.TokenType.NE_STRICT, _tokens.TokenType.LT, _tokens.TokenType.GT, _tokens.TokenType.LTE, _tokens.TokenType.GTE, _tokens.TokenType.INSTANCEOF, _tokens.TokenType.IN, _tokens.TokenType.NOT, _tokens.TokenType.BIT_NOT, _tokens.TokenType.AWAIT, _tokens.TokenType.DELETE, _tokens.TokenType.TYPEOF, _tokens.TokenType.VOID, _tokens.TokenType.BREAK, _tokens.TokenType.CASE, _tokens.TokenType.CATCH, _tokens.TokenType.CLASS, _tokens.TokenType.CONTINUE, _tokens.TokenType.DEBUGGER, _tokens.TokenType.DEFAULT, _tokens.TokenType.DO, _tokens.TokenType.ELSE, _tokens.TokenType.EXPORT, _tokens.TokenType.EXTENDS, _tokens.TokenType.FINALLY, _tokens.TokenType.FOR, _tokens.TokenType.FUNCTION, _tokens.TokenType.IF, _tokens.TokenType.IMPORT, _tokens.TokenType.LET, _tokens.TokenType.NEW, _tokens.TokenType.RETURN, _tokens.TokenType.SUPER, _tokens.TokenType.SWITCH, _tokens.TokenType.THIS, _tokens.TokenType.THROW, _tokens.TokenType.TRY, _tokens.TokenType.VAR, _tokens.TokenType.WHILE, _tokens.TokenType.WITH, _tokens.TokenType.NULL, _tokens.TokenType.TRUE, _tokens.TokenType.FALSE, _tokens.TokenType.YIELD, _tokens.TokenType.NUMBER, _tokens.TokenType.STRING, _tokens.TokenType.REGEXP, _tokens.TokenType.IDENTIFIER, _tokens.TokenType.CONST, _tokens.TokenType.TEMPLATE, _tokens.TokenType.ILLEGAL];

let ListHandler = _transitJs2.default.makeWriteHandler({
  tag: () => "array",
  rep: v => v
});

let MapHandler = _transitJs2.default.makeWriteHandler({
  tag: function tag() {
    return "map";
  },
  rep: function rep(v) {
    return v;
  },
  stringRep: function stringRep() {
    return null;
  }
});

let SyntaxHandler = _transitJs2.default.makeWriteHandler({
  tag: () => "stx",
  rep: v => {
    if (_immutable.List.isList(v.token)) {
      return [v.token, v.scopesets];
    } else {
      let t = _transitJs2.default.objectToMap(v.token);
      t.set("type", typeMap.indexOf(v.token.type));
      return [t, v.scopesets];
    }
  }
});
let SymbolHandler = _transitJs2.default.makeWriteHandler({
  tag: () => "symb",
  rep: v => [v.name]
});

let writer = _transitJs2.default.writer("json", {
  handlers: _transitJs2.default.map([_immutable.List, ListHandler, _immutable.Map, MapHandler, _syntax2.default, SyntaxHandler, _symbol.SymbolClass, SymbolHandler])
});

function makeReader(bindings) {
  return _transitJs2.default.reader("json", {
    arrayBuilder: {
      init: () => (0, _immutable.List)().asMutable(),
      add: (ret, val) => ret.push(val),
      finalize: ret => ret.asImmutable(),
      fromArray: arr => (0, _immutable.List)(arr)
    },
    mapBuilder: {
      init: function init() {
        return (0, _immutable.Map)().asMutable();
      },
      add: function add(ret, key, val) {
        return ret.set(key, val);
      },
      finalize: function finalize(ret) {
        return ret.asImmutable();
      }
    },
    handlers: {
      "stx": rep => {
        let scopesets = _transitJs2.default.mapToObject(rep[1]);
        if (_immutable.List.isList(rep[0])) {
          let token = rep[0];
          return new _syntax2.default(token, { bindings: bindings, scopesets: scopesets });
        } else {
          let token = _transitJs2.default.mapToObject(rep[0]);
          token.type = typeMap[rep[0].get("type")];
          token.slice = rep[0].has("slice") ? _transitJs2.default.mapToObject(rep[0].get("slice")) : undefined;
          if (token.slice) {
            token.slice.startLocation = _transitJs2.default.mapToObject(token.slice.startLocation);
          }
          return new _syntax2.default(token, { bindings: bindings, scopesets: scopesets });
        }
      },
      "symb": rep => {
        return (0, _symbol.Symbol)(rep[0]);
      }
    }
  });
}

exports.makeDeserializer = makeReader;
exports.serializer = writer;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9zZXJpYWxpemVyLmpzIl0sIm5hbWVzIjpbInR5cGVNYXAiLCJTVFJJTkciLCJFT1MiLCJMUEFSRU4iLCJSUEFSRU4iLCJMQlJBQ0siLCJSQlJBQ0siLCJMQlJBQ0UiLCJSQlJBQ0UiLCJDT0xPTiIsIlNFTUlDT0xPTiIsIlBFUklPRCIsIkVMTElQU0lTIiwiQVJST1ciLCJDT05ESVRJT05BTCIsIklOQyIsIkRFQyIsIkFTU0lHTiIsIkFTU0lHTl9CSVRfT1IiLCJBU1NJR05fQklUX1hPUiIsIkFTU0lHTl9CSVRfQU5EIiwiQVNTSUdOX1NITCIsIkFTU0lHTl9TSFIiLCJBU1NJR05fU0hSX1VOU0lHTkVEIiwiQVNTSUdOX0FERCIsIkFTU0lHTl9TVUIiLCJBU1NJR05fTVVMIiwiQVNTSUdOX0RJViIsIkFTU0lHTl9NT0QiLCJDT01NQSIsIk9SIiwiQU5EIiwiQklUX09SIiwiQklUX1hPUiIsIkJJVF9BTkQiLCJTSEwiLCJTSFIiLCJTSFJfVU5TSUdORUQiLCJBREQiLCJTVUIiLCJNVUwiLCJESVYiLCJNT0QiLCJFUSIsIk5FIiwiRVFfU1RSSUNUIiwiTkVfU1RSSUNUIiwiTFQiLCJHVCIsIkxURSIsIkdURSIsIklOU1RBTkNFT0YiLCJJTiIsIk5PVCIsIkJJVF9OT1QiLCJBV0FJVCIsIkRFTEVURSIsIlRZUEVPRiIsIlZPSUQiLCJCUkVBSyIsIkNBU0UiLCJDQVRDSCIsIkNMQVNTIiwiQ09OVElOVUUiLCJERUJVR0dFUiIsIkRFRkFVTFQiLCJETyIsIkVMU0UiLCJFWFBPUlQiLCJFWFRFTkRTIiwiRklOQUxMWSIsIkZPUiIsIkZVTkNUSU9OIiwiSUYiLCJJTVBPUlQiLCJMRVQiLCJORVciLCJSRVRVUk4iLCJTVVBFUiIsIlNXSVRDSCIsIlRISVMiLCJUSFJPVyIsIlRSWSIsIlZBUiIsIldISUxFIiwiV0lUSCIsIk5VTEwiLCJUUlVFIiwiRkFMU0UiLCJZSUVMRCIsIk5VTUJFUiIsIlJFR0VYUCIsIklERU5USUZJRVIiLCJDT05TVCIsIlRFTVBMQVRFIiwiSUxMRUdBTCIsIkxpc3RIYW5kbGVyIiwibWFrZVdyaXRlSGFuZGxlciIsInRhZyIsInJlcCIsInYiLCJNYXBIYW5kbGVyIiwic3RyaW5nUmVwIiwiU3ludGF4SGFuZGxlciIsImlzTGlzdCIsInRva2VuIiwic2NvcGVzZXRzIiwidCIsIm9iamVjdFRvTWFwIiwic2V0IiwiaW5kZXhPZiIsInR5cGUiLCJTeW1ib2xIYW5kbGVyIiwibmFtZSIsIndyaXRlciIsImhhbmRsZXJzIiwibWFwIiwibWFrZVJlYWRlciIsImJpbmRpbmdzIiwicmVhZGVyIiwiYXJyYXlCdWlsZGVyIiwiaW5pdCIsImFzTXV0YWJsZSIsImFkZCIsInJldCIsInZhbCIsInB1c2giLCJmaW5hbGl6ZSIsImFzSW1tdXRhYmxlIiwiZnJvbUFycmF5IiwiYXJyIiwibWFwQnVpbGRlciIsImtleSIsIm1hcFRvT2JqZWN0IiwiZ2V0Iiwic2xpY2UiLCJoYXMiLCJ1bmRlZmluZWQiLCJzdGFydExvY2F0aW9uIiwibWFrZURlc2VyaWFsaXplciIsInNlcmlhbGl6ZXIiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7QUFBQTs7OztBQUNBOztBQUNBOzs7O0FBQ0E7O0FBQ0E7Ozs7QUFFQSxJQUFJQSxVQUFVLENBQUMsa0JBQVVDLE1BQVgsRUFBbUIsa0JBQVVDLEdBQTdCLEVBQWtDLGtCQUFVQyxNQUE1QyxFQUFvRCxrQkFBVUMsTUFBOUQsRUFDQyxrQkFBVUMsTUFEWCxFQUNtQixrQkFBVUMsTUFEN0IsRUFDcUMsa0JBQVVDLE1BRC9DLEVBQ3VELGtCQUFVQyxNQURqRSxFQUVDLGtCQUFVQyxLQUZYLEVBRWtCLGtCQUFVQyxTQUY1QixFQUV1QyxrQkFBVUMsTUFGakQsRUFFeUQsa0JBQVVDLFFBRm5FLEVBR0Msa0JBQVVDLEtBSFgsRUFHa0Isa0JBQVVDLFdBSDVCLEVBR3lDLGtCQUFVQyxHQUhuRCxFQUd3RCxrQkFBVUMsR0FIbEUsRUFJQyxrQkFBVUMsTUFKWCxFQUltQixrQkFBVUMsYUFKN0IsRUFJNEMsa0JBQVVDLGNBSnRELEVB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Q0FBb0I1QixNQUFNOEIsS0FBTixDQUFZRyxhQUFoQyxDQUE1QjtBQUNEO0FBQ0QsaUJBQU8scUJBQVdqQyxLQUFYLEVBQWtCLEVBQUNhLGtCQUFELEVBQVdaLFdBQVdBLFNBQXRCLEVBQWxCLENBQVA7QUFDRDtBQUNGLE9BZk87QUFnQlIsY0FBU1AsR0FBRCxJQUFTO0FBQ2YsZUFBTyxvQkFBT0EsSUFBSSxDQUFKLENBQVAsQ0FBUDtBQUNEO0FBbEJPO0FBWmtCLEdBQXZCLENBQVA7QUFpQ0Q7O1FBR2V3QyxnQixHQUFkdEIsVTtRQUEwQ3VCLFUsR0FBVjFCLE0iLCJmaWxlIjoic2VyaWFsaXplci5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB0cmFuc2l0IGZyb20gXCJ0cmFuc2l0LWpzXCI7XG5pbXBvcnQgeyBMaXN0LCBNYXAgfSBmcm9tIFwiaW1tdXRhYmxlXCI7XG5pbXBvcnQgU3ludGF4IGZyb20gXCIuL3N5bnRheFwiO1xuaW1wb3J0IHsgU3ltYm9sLCAgU3ltYm9sQ2xhc3MgfSBmcm9tIFwiLi9zeW1ib2xcIjtcbmltcG9ydCB7IFRva2VuVHlwZSB9IGZyb20gXCIuL3Rva2Vuc1wiO1xuXG5sZXQgdHlwZU1hcCA9IFtUb2tlblR5cGUuU1RSSU5HLCBUb2tlblR5cGUuRU9TLCBUb2tlblR5cGUuTFBBUkVOLCBUb2tlblR5cGUuUlBBUkVOLFxuICAgICAgICAgICAgICAgVG9rZW5UeXBlLkxCUkFDSywgVG9rZW5UeXBlLlJCUkFDSywgVG9rZW5UeXBlLkxCUkFDRSwgVG9rZW5UeXBlLlJCUkFDRSxcbiAgICAgICAgICAgICAgIFRva2VuVHlwZS5DT0xPTiwgVG9rZW5UeXBlLlNFTUlDT0xPTiwgVG9rZW5UeXBlLlBFUklPRCwgVG9rZW5UeXBlLkVMTElQU0lTLFxuICAgICAgICAgICAgICAgVG9rZW5UeXBlLkFSUk9XLCBUb2tlblR5cGUuQ09ORElUSU9OQUwsIFRva2VuVHlwZS5JTkMsIFRva2VuVHlwZS5ERUMsXG4gICAgICAgICAgICAgICBUb2tlblR5cGUuQVNTSUdOLCBUb2tlblR5cGUuQVNTSUdOX0JJVF9PUiwgVG9rZW5UeXBlLkFTU0lHTl9CSVRfWE9SLFxuICAgICAgICAgICAgICAgVG9rZW5UeXBlLkFTU0lHTl9CSVRfQU5ELCBUb2tlblR5cGUuQVNTSUdOX1NITCwgVG9rZW5UeXBlLkFTU0lHTl9TSFIsXG4gICAgICAgICAgICAgICBUb2tlblR5cGUuQVNTSUdOX1NIUl9VTlNJR05FRCwgVG9rZW5UeXBlLkFTU0lHTl9BREQsIFRva2VuVHlwZS5BU1NJR05fU1VCLFxuICAgICAgICAgICAgICAgVG9rZW5UeXBlLkFTU0lHTl9NVUwsIFRva2VuVHlwZS5BU1NJR05fRElWLCBUb2tlblR5cGUuQVNTSUdOX01PRCxcbiAgICAgICAgICAgICAgIFRva2VuVHlwZS5DT01NQSwgVG9rZW5UeXBlLk9SLCBUb2tlblR5cGUuQU5ELCBUb2tlblR5cGUuQklUX09SLFxuICAgICAgICAgICAgICAgVG9rZW5UeXBlLkJJVF9YT1IsIFRva2VuVHlwZS5CSVRfQU5ELCBUb2tlblR5cGUuU0hMLCBUb2tlblR5cGUuU0hSLFxuICAgICAgICAgICAgICAgVG9rZW5UeXBlLlNIUl9VTlNJR05FRCwgVG9rZW5UeXBlLkFERCwgVG9rZW5UeXBlLlNVQiwgVG9rZW5UeXBlLk1VTCxcbiAgICAgICAgICAgICAgIFRva2VuVHlwZS5ESVYsIFRva2VuVHlwZS5NT0QsIFRva2VuVHlwZS5FUSwgVG9rZW5UeXBlLk5FLFxuICAgICAgICAgICAgICAgVG9rZW5UeXBlLkVRX1NUUklDVCwgVG9rZW5UeXBlLk5FX1NUUklDVCwgVG9rZW5UeXBlLkxULCBUb2tlblR5cGUuR1QsXG4gICAgICAgICAgICAgICBUb2tlblR5cGUuTFRFLCBUb2tlblR5cGUuR1RFLCBUb2tlblR5cGUuSU5TVEFOQ0VPRiwgVG9rZW5UeXBlLklOLFxuICAgICAgICAgICAgICAgVG9rZW5UeXBlLk5PVCwgVG9rZW5UeXBlLkJJVF9OT1QsIFRva2VuVHlwZS5BV0FJVCwgVG9rZW5UeXBlLkRFTEVURSxcbiAgICAgICAgICAgICAgIFRva2VuVHlwZS5UWVBFT0YsIFRva2VuVHlwZS5WT0lELCBUb2tlblR5cGUuQlJFQUssIFRva2VuVHlwZS5DQVNFLFxuICAgICAgICAgICAgICAgVG9rZW5UeXBlLkNBVENILCBUb2tlblR5cGUuQ0xBU1MsIFRva2VuVHlwZS5DT05USU5VRSwgVG9rZW5UeXBlLkRFQlVHR0VSLFxuICAgICAgICAgICAgICAgVG9rZW5UeXBlLkRFRkFVTFQsIFRva2VuVHlwZS5ETywgVG9rZW5UeXBlLkVMU0UsIFRva2VuVHlwZS5FWFBPUlQsXG4gICAgICAgICAgICAgICBUb2tlblR5cGUuRVhURU5EUywgVG9rZW5UeXBlLkZJTkFMTFksIFRva2VuVHlwZS5GT1IsIFRva2VuVHlwZS5GVU5DVElPTixcbiAgICAgICAgICAgICAgIFRva2VuVHlwZS5JRiwgVG9rZW5UeXBlLklNUE9SVCwgVG9rZW5UeXBlLkxFVCwgVG9rZW5UeXBlLk5FVyxcbiAgICAgICAgICAgICAgIFRva2VuVHlwZS5SRVRVUk4sIFRva2VuVHlwZS5TVVBFUiwgVG9rZW5UeXBlLlNXSVRDSCwgVG9rZW5UeXBlLlRISVMsXG4gICAgICAgICAgICAgICBUb2tlblR5cGUuVEhST1csIFRva2VuVHlwZS5UUlksIFRva2VuVHlwZS5WQVIsIFRva2VuVHlwZS5XSElMRSxcbiAgICAgICAgICAgICAgIFRva2VuVHlwZS5XSVRILCBUb2tlblR5cGUuTlVMTCwgVG9rZW5UeXBlLlRSVUUsIFRva2VuVHlwZS5GQUxTRSxcbiAgICAgICAgICAgICAgIFRva2VuVHlwZS5ZSUVMRCwgVG9rZW5UeXBlLk5VTUJFUiwgVG9rZW5UeXBlLlNUUklORywgVG9rZW5UeXBlLlJFR0VYUCxcbiAgICAgICAgICAgICAgIFRva2VuVHlwZS5JREVOVElGSUVSLCBUb2tlblR5cGUuQ09OU1QsIFRva2VuVHlwZS5URU1QTEFURSxcbiAgICAgICAgICAgICAgIFRva2VuVHlwZS5JTExFR0FMXTtcblxubGV0IExpc3RIYW5kbGVyID0gdHJhbnNpdC5tYWtlV3JpdGVIYW5kbGVyKHtcbiAgdGFnOiAoKSA9PiBcImFycmF5XCIsXG4gIHJlcDogKHYpID0+IHZcbn0pO1xuXG5sZXQgTWFwSGFuZGxlciA9IHRyYW5zaXQubWFrZVdyaXRlSGFuZGxlcih7XG4gIHRhZzogZnVuY3Rpb24oKSB7IHJldHVybiBcIm1hcFwiOyB9LFxuICByZXA6IGZ1bmN0aW9uKHYpIHsgcmV0dXJuIHY7IH0sXG4gIHN0cmluZ1JlcDogZnVuY3Rpb24oKSB7IHJldHVybiBudWxsOyB9XG59KTtcblxubGV0IFN5bnRheEhhbmRsZXIgPSB0cmFuc2l0Lm1ha2VXcml0ZUhhbmRsZXIoe1xuICB0YWc6ICgpID0+IFwic3R4XCIsXG4gIHJlcDogKHYpID0+IHtcbiAgICBpZiAoTGlzdC5pc0xpc3Qodi50b2tlbikpIHtcbiAgICAgIHJldHVybiBbdi50b2tlbiwgdi5zY29wZXNldHNdO1xuICAgIH0gZWxzZSB7XG4gICAgICBsZXQgdCA9IHRyYW5zaXQub2JqZWN0VG9NYXAodi50b2tlbik7XG4gICAgICB0LnNldChcInR5cGVcIiwgdHlwZU1hcC5pbmRleE9mKHYudG9rZW4udHlwZSkpO1xuICAgICAgcmV0dXJuIFt0LCB2LnNjb3Blc2V0c107XG4gICAgfVxuICB9XG59KTtcbmxldCBTeW1ib2xIYW5kbGVyID0gdHJhbnNpdC5tYWtlV3JpdGVIYW5kbGVyKHtcbiAgdGFnOiAoKSA9PiBcInN5bWJcIixcbiAgcmVwOiAodikgPT4gIFt2Lm5hbWVdXG59KTtcblxubGV0IHdyaXRlciA9IHRyYW5zaXQud3JpdGVyKFwianNvblwiLCB7XG4gIGhhbmRsZXJzOiB0cmFuc2l0Lm1hcChbXG4gICAgTGlzdCwgTGlzdEhhbmRsZXIsXG4gICAgTWFwLCBNYXBIYW5kbGVyLFxuICAgIFN5bnRheCwgU3ludGF4SGFuZGxlcixcbiAgICBTeW1ib2xDbGFzcywgU3ltYm9sSGFuZGxlclxuICBdKVxufSk7XG5cbmZ1bmN0aW9uIG1ha2VSZWFkZXIoYmluZGluZ3MpIHtcbiAgcmV0dXJuIHRyYW5zaXQucmVhZGVyKFwianNvblwiLCB7XG4gICAgYXJyYXlCdWlsZGVyOiB7XG4gICAgICBpbml0OiAoKSA9PiBMaXN0KCkuYXNNdXRhYmxlKCksXG4gICAgICBhZGQ6IChyZXQsIHZhbCkgPT4gcmV0LnB1c2godmFsKSxcbiAgICAgIGZpbmFsaXplOiAocmV0KSA9PiByZXQuYXNJbW11dGFibGUoKSxcbiAgICAgIGZyb21BcnJheTogKGFycikgPT4gTGlzdChhcnIpXG4gICAgfSxcbiAgICBtYXBCdWlsZGVyOiB7XG4gICAgICBpbml0OiBmdW5jdGlvbigpIHsgcmV0dXJuIE1hcCgpLmFzTXV0YWJsZSgpOyB9LFxuICAgICAgYWRkOiBmdW5jdGlvbihyZXQsIGtleSwgdmFsKSB7IHJldHVybiByZXQuc2V0KGtleSwgdmFsKTsgfSxcbiAgICAgIGZpbmFsaXplOiBmdW5jdGlvbihyZXQpIHsgcmV0dXJuIHJldC5hc0ltbXV0YWJsZSgpOyB9XG4gICAgfSxcbiAgICBoYW5kbGVyczoge1xuICAgICAgXCJzdHhcIjogKHJlcCkgPT4ge1xuICAgICAgICBsZXQgc2NvcGVzZXRzID0gdHJhbnNpdC5tYXBUb09iamVjdChyZXBbMV0pO1xuICAgICAgICBpZiAoTGlzdC5pc0xpc3QocmVwWzBdKSkge1xuICAgICAgICAgIGxldCB0b2tlbiA9IHJlcFswXTtcbiAgICAgICAgICByZXR1cm4gbmV3IFN5bnRheCh0b2tlbiwge2JpbmRpbmdzLCBzY29wZXNldHM6IHNjb3Blc2V0c30pO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIGxldCB0b2tlbiA9IHRyYW5zaXQubWFwVG9PYmplY3QocmVwWzBdKTtcbiAgICAgICAgICB0b2tlbi50eXBlID0gdHlwZU1hcFtyZXBbMF0uZ2V0KFwidHlwZVwiKV07XG4gICAgICAgICAgdG9rZW4uc2xpY2UgPSByZXBbMF0uaGFzKFwic2xpY2VcIikgPyB0cmFuc2l0Lm1hcFRvT2JqZWN0KHJlcFswXS5nZXQoXCJzbGljZVwiKSkgOiB1bmRlZmluZWQ7XG4gICAgICAgICAgaWYgKHRva2VuLnNsaWNlKSB7XG4gICAgICAgICAgICB0b2tlbi5zbGljZS5zdGFydExvY2F0aW9uID0gdHJhbnNpdC5tYXBUb09iamVjdCh0b2tlbi5zbGljZS5zdGFydExvY2F0aW9uKTtcbiAgICAgICAgICB9XG4gICAgICAgICAgcmV0dXJuIG5ldyBTeW50YXgodG9rZW4sIHtiaW5kaW5ncywgc2NvcGVzZXRzOiBzY29wZXNldHN9KTtcbiAgICAgICAgfVxuICAgICAgfSxcbiAgICAgIFwic3ltYlwiOiAocmVwKSA9PiB7XG4gICAgICAgIHJldHVybiBTeW1ib2wocmVwWzBdKTtcbiAgICAgIH1cbiAgICB9XG4gIH0pO1xufVxuXG5leHBvcnQge1xuICBtYWtlUmVhZGVyIGFzIG1ha2VEZXNlcmlhbGl6ZXIsIHdyaXRlciBhcyBzZXJpYWxpemVyXG59O1xuIl19