'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});

var _sweetSpec = require('sweet-spec');

var T = _interopRequireWildcard(_sweetSpec);

var _ramda = require('ramda');

var _ = _interopRequireWildcard(_ramda);

var _sweetSpecUtils = require('./sweet-spec-utils');

var S = _interopRequireWildcard(_sweetSpecUtils);

var _codegen = require('./codegen');

var _codegen2 = _interopRequireDefault(_codegen);

var _immutable = require('immutable');

var _sweetToShiftReducer = require('./sweet-to-shift-reducer.js');

var _sweetToShiftReducer2 = _interopRequireDefault(_sweetToShiftReducer);

var _syntax = require('./syntax');

var _syntax2 = _interopRequireDefault(_syntax);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function _interopRequireWildcard(obj) { if (obj && obj.__esModule) { return obj; } else { var newObj = {}; if (obj != null) { for (var key in obj) { if (Object.prototype.hasOwnProperty.call(obj, key)) newObj[key] = obj[key]; } } newObj.default = obj; return newObj; } }

const extractDeclaration = _.cond([[S.isExport, _.prop('declaration')], [S.isExportDefault, _.prop('body')], [_.T, term => {
  throw new Error(`Expecting an Export or ExportDefault but got ${term}`);
}]]);


const ExpSpec = x => ({
  exportedName: x
});

const extractDeclarationNames = _.cond([[S.isVariableDeclarator, ({ binding }) => _immutable.List.of(binding.name)], [S.isVariableDeclaration, ({ declarators }) => declarators.flatMap(extractDeclarationNames)], [S.isFunctionDeclaration, ({ name }) => _immutable.List.of(name.name)], [S.isClassDeclaration, ({ name }) => _immutable.List.of(name.name)]]);

const extractDeclarationSpecifiers = _.cond([[S.isVariableDeclarator, ({ binding }) => _immutable.List.of(ExpSpec(binding.name))], [S.isVariableDeclaration, ({ declarators }) => declarators.flatMap(extractDeclarationSpecifiers)], [S.isFunctionDeclaration, ({ name }) => _immutable.List.of(ExpSpec(name.name))], [S.isClassDeclaration, ({ name }) => _immutable.List.of(ExpSpec(name.name))]]);

function extractSpecifiers(term) {
  if (S.isExport(term)) {
    return extractDeclarationSpecifiers(term.declaration);
  } else if (S.isExportDefault(term)) {
    return (0, _immutable.List)();
  } else if (S.isExportFrom(term)) {
    return term.namedExports;
  }
  throw new Error(`Unknown export type`);
}

function wrapStatement(declaration) {
  if (S.isVariableDeclaration(declaration)) {
    return new T.VariableDeclarationStatement({
      declaration
    });
  }
  return declaration;
}

const memoSym = Symbol('memo');

function makeVarDeclStmt(name, expr) {
  return new T.VariableDeclarationStatement({
    declaration: new T.VariableDeclaration({
      kind: 'var',
      declarators: _immutable.List.of(new T.VariableDeclarator({
        binding: name,
        init: expr
      }))
    })
  });
}

class SweetModule {

  constructor(path, items) {
    let moreDirectives = true;
    let directives = [];
    let body = [];
    let imports = [];
    let exports = [];
    this.path = path;
    this.exportedNames = (0, _immutable.List)();
    for (let item of items) {
      if (moreDirectives && item instanceof T.ExpressionStatement && item.expression instanceof T.LiteralStringExpression) {
        directives.push(item.expression.value);
        continue;
      } else {
        moreDirectives = false;
      }

      if (item instanceof T.ImportDeclaration) {
        imports.push(item);
      } else if (item instanceof T.ExportDeclaration) {
        if (S.isExport(item)) {
          let decl = extractDeclaration(item);
          let stmt = wrapStatement(decl);
          let names = extractDeclarationNames(decl);
          body.push(stmt);
          let exp = new T.ExportFrom({
            moduleSpecifier: null,
            namedExports: names.map(name => new T.ExportSpecifier({
              name,
              exportedName: name
            }))
          });
          body.push(exp);
          exports.push(exp);
          this.exportedNames = this.exportedNames.concat(extractSpecifiers(exp));
        } else if (item instanceof T.ExportFrom) {
          let exp = new T.ExportFrom({
            moduleSpecifier: item.moduleSpecifier,
            namedExports: item.namedExports.map(({ name, exportedName }) => {
              if (name == null) {
                return new T.ExportSpecifier({
                  name: exportedName,
                  exportedName
                });
              }
              return new T.ExportSpecifier({
                name,
                exportedName
              });
            })
          });
          body.push(exp);
          exports.push(exp);
          this.exportedNames = this.exportedNames.concat(extractSpecifiers(exp));
        } else {
          exports.push(item);
          body.push(item);
          this.exportedNames = this.exportedNames.concat(extractSpecifiers(item));
          if (S.isExportDefault(item)) {
            this.defaultExport = _syntax2.default.fromIdentifier('_default');
            this.exportedNames = this.exportedNames.push(ExpSpec(this.defaultExport));
          }
        }
      } else {
        body.push(item);
      }
    }
    this.items = (0, _immutable.List)(body);
    this.imports = (0, _immutable.List)(imports);
    this.exports = (0, _immutable.List)(exports);
    this.directives = (0, _immutable.List)(directives);
  }

  // $FlowFixMe: flow doesn't support computed property keys yet
  [memoSym]() {
    let runtime = [],
        compiletime = [];
    for (let item of this.items) {
      if (S.isExportDeclaration(item)) {
        if (S.isExportDefault(item)) {
          let decl = extractDeclaration(item);
          let def = new T.BindingIdentifier({
            name: this.defaultExport
          });
          if (S.isFunctionDeclaration(decl) || S.isClassDeclaration(decl)) {
            runtime.push(decl);
            // extract name and bind it to _default
            runtime.push(makeVarDeclStmt(def, new T.IdentifierExpression({
              name: decl.name.name
            })));
          } else {
            // expression so bind it to _default
            let stmt = makeVarDeclStmt(def, decl);
            if (S.isCompiletimeStatement(stmt)) {
              compiletime.push(stmt);
            } else {
              runtime.push(stmt);
            }
          }
        }
      } else {
        if (S.isCompiletimeStatement(item)) {
          compiletime.push(item);
        } else {
          runtime.push(item);
        }
      }
    }
    this.runtime = (0, _immutable.List)(runtime);
    this.compiletime = (0, _immutable.List)(compiletime);
  }

  runtimeItems() {
    if (this.runtime == null) {
      // $FlowFixMe: flow doesn't support computed property keys yet
      this[memoSym]();
    }
    return this.runtime;
  }

  compiletimeItems() {
    if (this.compiletime == null) {
      // $FlowFixMe: flow doesn't support computed property keys yet
      this[memoSym]();
    }
    return this.compiletime;
  }

  parse() {
    return new T.Module({
      items: this.imports.concat(this.items),
      directives: this.directives
      // $FlowFixMe: flow doesn't know about reduce yet
    }).reduce(new _sweetToShiftReducer2.default(0));
  }

  codegen() {
    return (0, _codegen2.default)(this.parse()).code;
  }
}
exports.default = SweetModule;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9zd2VldC1tb2R1bGUuanMiXSwibmFtZXMiOlsiVCIsIl8iLCJTIiwiZXh0cmFjdERlY2xhcmF0aW9uIiwiY29uZCIsImlzRXhwb3J0IiwicHJvcCIsImlzRXhwb3J0RGVmYXVsdCIsInRlcm0iLCJFcnJvciIsIkV4cFNwZWMiLCJ4IiwiZXhwb3J0ZWROYW1lIiwiZXh0cmFjdERlY2xhcmF0aW9uTmFtZXMiLCJpc1ZhcmlhYmxlRGVjbGFyYXRvciIsImJpbmRpbmciLCJvZiIsIm5hbWUiLCJpc1ZhcmlhYmxlRGVjbGFyYXRpb24iLCJkZWNsYXJhdG9ycyIsImZsYXRNYXAiLCJpc0Z1bmN0aW9uRGVjbGFyYXRpb24iLCJpc0NsYXNzRGVjbGFyYXRpb24iLCJleHRyYWN0RGVjbGFyYXRpb25TcGVjaWZpZXJzIiwiZXh0cmFjdFNwZWNpZmllcnMiLCJkZWNsYXJhdGlvbiIsImlzRXhwb3J0RnJvbSIsIm5hbWVkRXhwb3J0cyIsIndyYXBTdGF0ZW1lbnQiLCJWYXJpYWJsZURlY2xhcmF0aW9uU3RhdGVtZW50IiwibWVtb1N5bSIsIlN5bWJvbCIsIm1ha2VWYXJEZWNsU3RtdCIsImV4cHIiLCJWYXJpYWJsZURlY2xhcmF0aW9uIiwia2luZCIsIlZhcmlhYmxlRGVjbGFyYXRvciIsImluaXQiLCJTd2VldE1vZHVsZSIsImNvbnN0cnVjdG9yIiwicGF0aCIsIml0ZW1zIiwibW9yZURpcmVjdGl2ZXMiLCJkaXJlY3RpdmVzIiwiYm9keSIsImltcG9ydHMiLCJleHBvcnRzIiwiZXhwb3J0ZWROYW1lcyIsIml0ZW0iLCJFeHByZXNzaW9uU3RhdGVtZW50IiwiZXhwcmVzc2lvbiIsIkxpdGVyYWxTdHJpbmdFeHByZXNzaW9uIiwicHVzaCIsInZhbHVlIiwiSW1wb3J0RGVjbGFyYXRpb24iLCJFeHBvcnREZWNsYXJhdGlvbiIsImRlY2wiLCJzdG10IiwibmFtZXMiLCJleHAiLCJFeHBvcnRGcm9tIiwibW9kdWxlU3BlY2lmaWVyIiwibWFwIiwiRXhwb3J0U3BlY2lmaWVyIiwiY29uY2F0IiwiZGVmYXVsdEV4cG9ydCIsImZyb21JZGVudGlmaWVyIiwicnVudGltZSIsImNvbXBpbGV0aW1lIiwiaXNFeHBvcnREZWNsYXJhdGlvbiIsImRlZiIsIkJpbmRpbmdJZGVudGlmaWVyIiwiSWRlbnRpZmllckV4cHJlc3Npb24iLCJpc0NvbXBpbGV0aW1lU3RhdGVtZW50IiwicnVudGltZUl0ZW1zIiwiY29tcGlsZXRpbWVJdGVtcyIsInBhcnNlIiwiTW9kdWxlIiwicmVkdWNlIiwiY29kZWdlbiIsImNvZGUiXSwibWFwcGluZ3MiOiI7Ozs7OztBQUNBOztJQUFrQkEsQzs7QUFDbEI7O0lBQVlDLEM7O0FBQ1o7O0lBQVlDLEM7O0FBQ1o7Ozs7QUFDQTs7QUFDQTs7OztBQUNBOzs7Ozs7OztBQUVBLE1BQU1DLHFCQUFxQkYsRUFBRUcsSUFBRixDQUFPLENBQ2hDLENBQUNGLEVBQUVHLFFBQUgsRUFBYUosRUFBRUssSUFBRixDQUFPLGFBQVAsQ0FBYixDQURnQyxFQUVoQyxDQUFDSixFQUFFSyxlQUFILEVBQW9CTixFQUFFSyxJQUFGLENBQU8sTUFBUCxDQUFwQixDQUZnQyxFQUdoQyxDQUNFTCxFQUFFRCxDQURKLEVBRUVRLFFBQVE7QUFDTixRQUFNLElBQUlDLEtBQUosQ0FBVyxnREFBK0NELElBQUssRUFBL0QsQ0FBTjtBQUNELENBSkgsQ0FIZ0MsQ0FBUCxDQUEzQjs7O0FBV0EsTUFBTUUsVUFBVUMsTUFBTTtBQUNwQkMsZ0JBQWNEO0FBRE0sQ0FBTixDQUFoQjs7QUFJQSxNQUFNRSwwQkFBMEJaLEVBQUVHLElBQUYsQ0FBTyxDQUNyQyxDQUFDRixFQUFFWSxvQkFBSCxFQUF5QixDQUFDLEVBQUVDLE9BQUYsRUFBRCxLQUFpQixnQkFBS0MsRUFBTCxDQUFRRCxRQUFRRSxJQUFoQixDQUExQyxDQURxQyxFQUVyQyxDQUNFZixFQUFFZ0IscUJBREosRUFFRSxDQUFDLEVBQUVDLFdBQUYsRUFBRCxLQUFxQkEsWUFBWUMsT0FBWixDQUFvQlAsdUJBQXBCLENBRnZCLENBRnFD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O0FBQ0Y7QUFDRixPQTNCRCxNQTJCTztBQUNMLFlBQUl2RCxFQUFFdUUsc0JBQUYsQ0FBeUJ6QixJQUF6QixDQUFKLEVBQW9DO0FBQ2xDb0Isc0JBQVloQixJQUFaLENBQWlCSixJQUFqQjtBQUNELFNBRkQsTUFFTztBQUNMbUIsa0JBQVFmLElBQVIsQ0FBYUosSUFBYjtBQUNEO0FBQ0Y7QUFDRjtBQUNELFNBQUttQixPQUFMLEdBQWUscUJBQUtBLE9BQUwsQ0FBZjtBQUNBLFNBQUtDLFdBQUwsR0FBbUIscUJBQUtBLFdBQUwsQ0FBbkI7QUFDRDs7QUFFRE0saUJBQWU7QUFDYixRQUFJLEtBQUtQLE9BQUwsSUFBZ0IsSUFBcEIsRUFBMEI7QUFDeEI7QUFDQSxXQUFLckMsT0FBTDtBQUNEO0FBQ0QsV0FBTyxLQUFLcUMsT0FBWjtBQUNEOztBQUVEUSxxQkFBbUI7QUFDakIsUUFBSSxLQUFLUCxXQUFMLElBQW9CLElBQXhCLEVBQThCO0FBQzVCO0FBQ0EsV0FBS3RDLE9BQUw7QUFDRDtBQUNELFdBQU8sS0FBS3NDLFdBQVo7QUFDRDs7QUFFRFEsVUFBUTtBQUNOLFdBQU8sSUFBSTVFLEVBQUU2RSxNQUFOLENBQWE7QUFDbEJwQyxhQUFRLEtBQUtJLE9BQU4sQ0FBb0JtQixNQUFwQixDQUEyQixLQUFLdkIsS0FBaEMsQ0FEVztBQUVsQkUsa0JBQVksS0FBS0E7QUFDakI7QUFIa0IsS0FBYixFQUlKbUMsTUFKSSxDQUlHLGtDQUF3QixDQUF4QixDQUpILENBQVA7QUFLRDs7QUFFREMsWUFBVTtBQUNSLFdBQU8sdUJBQVEsS0FBS0gsS0FBTCxFQUFSLEVBQXNCSSxJQUE3QjtBQUNEO0FBeks4QjtrQkFBWjFDLFciLCJmaWxlIjoic3dlZXQtbW9kdWxlLmpzIiwic291cmNlc0NvbnRlbnQiOlsiLy8gQGZsb3dcbmltcG9ydCBUZXJtLCAqIGFzIFQgZnJvbSAnc3dlZXQtc3BlYyc7XG5pbXBvcnQgKiBhcyBfIGZyb20gJ3JhbWRhJztcbmltcG9ydCAqIGFzIFMgZnJvbSAnLi9zd2VldC1zcGVjLXV0aWxzJztcbmltcG9ydCBjb2RlZ2VuIGZyb20gJy4vY29kZWdlbic7XG5pbXBvcnQgeyBMaXN0IH0gZnJvbSAnaW1tdXRhYmxlJztcbmltcG9ydCBTd2VldFRvU2hpZnRSZWR1Y2VyIGZyb20gJy4vc3dlZXQtdG8tc2hpZnQtcmVkdWNlci5qcyc7XG5pbXBvcnQgU3ludGF4IGZyb20gJy4vc3ludGF4JztcblxuY29uc3QgZXh0cmFjdERlY2xhcmF0aW9uID0gXy5jb25kKFtcbiAgW1MuaXNFeHBvcnQsIF8ucHJvcCgnZGVjbGFyYXRpb24nKV0sXG4gIFtTLmlzRXhwb3J0RGVmYXVsdCwgXy5wcm9wKCdib2R5JyldLFxuICBbXG4gICAgXy5ULFxuICAgIHRlcm0gPT4ge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBFeHBlY3RpbmcgYW4gRXhwb3J0IG9yIEV4cG9ydERlZmF1bHQgYnV0IGdvdCAke3Rlcm19YCk7XG4gICAgfSxcbiAgXSxcbl0pO1xuXG5jb25zdCBFeHBTcGVjID0geCA9PiAoe1xuICBleHBvcnRlZE5hbWU6IHgsXG59KTtcblxuY29uc3QgZXh0cmFjdERlY2xhcmF0aW9uTmFtZXMgPSBfLmNvbmQoW1xuICBbUy5pc1ZhcmlhYmxlRGVjbGFyYXRvciwgKHsgYmluZGluZyB9KSA9PiBMaXN0Lm9mKGJpbmRpbmcubmFtZSldLFxuICBbXG4gICAgUy5pc1ZhcmlhYmxlRGVjbGFyYXRpb24sXG4gICAgKHsgZGVjbGFyYXRvcnMgfSkgPT4gZGVjbGFyYXRvcnMuZmxhdE1hcChleHRyYWN0RGVjbGFyYXRpb25OYW1lcyksXG4gIF0sXG4gIFtTLmlzRnVuY3Rpb25EZWNsYXJhdGlvbiwgKHsgbmFtZSB9KSA9PiBMaXN0Lm9mKG5hbWUubmFtZSldLFxuICBbUy5pc0NsYXNzRGVjbGFyYXRpb24sICh7IG5hbWUgfSkgPT4gTGlzdC5vZihuYW1lLm5hbWUpXSxcbl0pO1xuXG5jb25zdCBleHRyYWN0RGVjbGFyYXRpb25TcGVjaWZpZXJzID0gXy5jb25kKFtcbiAgW1MuaXNWYXJpYWJsZURlY2xhcmF0b3IsICh7IGJpbmRpbmcgfSkgPT4gTGlzdC5vZihFeHBTcGVjKGJpbmRpbmcubmFtZSkpXSxcbiAgW1xuICAgIFMuaXNWYXJpYWJsZURlY2xhcmF0aW9uLFxuICAgICh7IGRlY2xhcmF0b3JzIH0pID0+IGRlY2xhcmF0b3JzLmZsYXRNYXAoZXh0cmFjdERlY2xhcmF0aW9uU3BlY2lmaWVycyksXG4gIF0sXG4gIFtTLmlzRnVuY3Rpb25EZWNsYXJhdGlvbiwgKHsgbmFtZSB9KSA9PiBMaXN0Lm9mKEV4cFNwZWMobmFtZS5uYW1lKSldLFxuICBbUy5pc0NsYXNzRGVjbGFyYXRpb24sICh7IG5hbWUgfSkgPT4gTGlzdC5vZihFeHBTcGVjKG5hbWUubmFtZSkpXSxcbl0pO1xuXG50eXBlIEV4cG9ydFNwZWNpZmllciA9IHtcbiAgbmFtZT86IFN5bnRheCxcbiAgZXhwb3J0ZWROYW1lOiBTeW50YXgsXG59O1xuXG5mdW5jdGlvbiBleHRyYWN0U3BlY2lmaWVycyh0ZXJtOiBhbnkpOiBMaXN0PEV4cG9ydFNwZWNpZmllcj4ge1xuICBpZiAoUy5pc0V4cG9ydCh0ZXJtKSkge1xuICAgIHJldHVybiBleHRyYWN0RGVjbGFyYXRpb25TcGVjaWZpZXJzKHRlcm0uZGVjbGFyYXRpb24pO1xuICB9IGVsc2UgaWYgKFMuaXNFeHBvcnREZWZhdWx0KHRlcm0pKSB7XG4gICAgcmV0dXJuIExpc3QoKTtcbiAgfSBlbHNlIGlmIChTLmlzRXhwb3J0RnJvbSh0ZXJtKSkge1xuICAgIHJldHVybiB0ZXJtLm5hbWVkRXhwb3J0cztcbiAgfVxuICB0aHJvdyBuZXcgRXJyb3IoYFVua25vd24gZXhwb3J0IHR5cGVgKTtcbn1cblxuZnVuY3Rpb24gd3JhcFN0YXRlbWVudChkZWNsYXJhdGlvbjogVGVybSkge1xuICBpZiAoUy5pc1ZhcmlhYmxlRGVjbGFyYXRpb24oZGVjbGFyYXRpb24pKSB7XG4gICAgcmV0dXJuIG5ldyBULlZhcmlhYmxlRGVjbGFyYXRpb25TdGF0ZW1lbnQoe1xuICAgICAgZGVjbGFyYXRpb24sXG4gICAgfSk7XG4gIH1cbiAgcmV0dXJuIGRlY2xhcmF0aW9uO1xufVxuXG5jb25zdCBtZW1vU3ltID0gU3ltYm9sKCdtZW1vJyk7XG5cbmZ1bmN0aW9uIG1ha2VWYXJEZWNsU3RtdChuYW1lOiBULkJpbmRpbmdJZGVudGlmaWVyLCBleHByOiBULkV4cHJlc3Npb24pIHtcbiAgcmV0dXJuIG5ldyBULlZhcmlhYmxlRGVjbGFyYXRpb25TdGF0ZW1lbnQoe1xuICAgIGRlY2xhcmF0aW9uOiBuZXcgVC5WYXJpYWJsZURlY2xhcmF0aW9uKHtcbiAgICAgIGtpbmQ6ICd2YXInLFxuICAgICAgZGVjbGFyYXRvcnM6IExpc3Qub2YoXG4gICAgICAgIG5ldyBULlZhcmlhYmxlRGVjbGFyYXRvcih7XG4gICAgICAgICAgYmluZGluZzogbmFtZSxcbiAgICAgICAgICBpbml0OiBleHByLFxuICAgICAgICB9KSxcbiAgICAgICksXG4gICAgfSksXG4gIH0pO1xufVxuXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBTd2VldE1vZHVsZSB7XG4gIHBhdGg6IHN0cmluZztcbiAgaXRlbXM6IExpc3Q8VGVybT47XG4gIGRpcmVjdGl2ZXM6IExpc3Q8c3RyaW5nPjtcbiAgaW1wb3J0czogTGlzdDxULkltcG9ydERlY2xhcmF0aW9uPjtcbiAgZXhwb3J0czogTGlzdDxULkV4cG9ydERlY2xhcmF0aW9uPjtcbiAgZXhwb3J0ZWROYW1lczogTGlzdDxFeHBvcnRTcGVjaWZpZXI+O1xuICBkZWZhdWx0RXhwb3J0OiBhbnk7XG5cbiAgcnVudGltZTogTGlzdDxUZXJtPjtcbiAgY29tcGlsZXRpbWU6IExpc3Q8VGVybT47XG5cbiAgY29uc3RydWN0b3IocGF0aDogc3RyaW5nLCBpdGVtczogTGlzdDxUZXJtPikge1xuICAgIGxldCBtb3JlRGlyZWN0aXZlcyA9IHRydWU7XG4gICAgbGV0IGRpcmVjdGl2ZXMgPSBbXTtcbiAgICBsZXQgYm9keSA9IFtdO1xuICAgIGxldCBpbXBvcnRzID0gW107XG4gICAgbGV0IGV4cG9ydHMgPSBbXTtcbiAgICB0aGlzLnBhdGggPSBwYXRoO1xuICAgIHRoaXMuZXhwb3J0ZWROYW1lcyA9IExpc3QoKTtcbiAgICBmb3IgKGxldCBpdGVtIG9mIGl0ZW1zKSB7XG4gICAgICBpZiAoXG4gICAgICAgIG1vcmVEaXJlY3RpdmVzICYmXG4gICAgICAgIGl0ZW0gaW5zdGFuY2VvZiBULkV4cHJlc3Npb25TdGF0ZW1lbnQgJiZcbiAgICAgICAgaXRlbS5leHByZXNzaW9uIGluc3RhbmNlb2YgVC5MaXRlcmFsU3RyaW5nRXhwcmVzc2lvblxuICAgICAgKSB7XG4gICAgICAgIGRpcmVjdGl2ZXMucHVzaChpdGVtLmV4cHJlc3Npb24udmFsdWUpO1xuICAgICAgICBjb250aW51ZTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIG1vcmVEaXJlY3RpdmVzID0gZmFsc2U7XG4gICAgICB9XG5cbiAgICAgIGlmIChpdGVtIGluc3RhbmNlb2YgVC5JbXBvcnREZWNsYXJhdGlvbikge1xuICAgICAgICBpbXBvcnRzLnB1c2goaXRlbSk7XG4gICAgICB9IGVsc2UgaWYgKGl0ZW0gaW5zdGFuY2VvZiBULkV4cG9ydERlY2xhcmF0aW9uKSB7XG4gICAgICAgIGlmIChTLmlzRXhwb3J0KGl0ZW0pKSB7XG4gICAgICAgICAgbGV0IGRlY2wgPSBleHRyYWN0RGVjbGFyYXRpb24oaXRlbSk7XG4gICAgICAgICAgbGV0IHN0bXQgPSB3cmFwU3RhdGVtZW50KGRlY2wpO1xuICAgICAgICAgIGxldCBuYW1lcyA9IGV4dHJhY3REZWNsYXJhdGlvbk5hbWVzKGRlY2wpO1xuICAgICAgICAgIGJvZHkucHVzaChzdG10KTtcbiAgICAgICAgICBsZXQgZXhwID0gbmV3IFQuRXhwb3J0RnJvbSh7XG4gICAgICAgICAgICBtb2R1bGVTcGVjaWZpZXI6IG51bGwsXG4gICAgICAgICAgICBuYW1lZEV4cG9ydHM6IG5hbWVzLm1hcChcbiAgICAgICAgICAgICAgbmFtZSA9PlxuICAgICAgICAgICAgICAgIG5ldyBULkV4cG9ydFNwZWNpZmllcih7XG4gICAgICAgICAgICAgICAgICBuYW1lLFxuICAgICAgICAgICAgICAgICAgZXhwb3J0ZWROYW1lOiBuYW1lLFxuICAgICAgICAgICAgICAgIH0pLFxuICAgICAgICAgICAgKSxcbiAgICAgICAgICB9KTtcbiAgICAgICAgICBib2R5LnB1c2goZXhwKTtcbiAgICAgICAgICBleHBvcnRzLnB1c2goZXhwKTtcbiAgICAgICAgICB0aGlzLmV4cG9ydGVkTmFtZXMgPSB0aGlzLmV4cG9ydGVkTmFtZXMuY29uY2F0KFxuICAgICAgICAgICAgZXh0cmFjdFNwZWNpZmllcnMoZXhwKSxcbiAgICAgICAgICApO1xuICAgICAgICB9IGVsc2UgaWYgKGl0ZW0gaW5zdGFuY2VvZiBULkV4cG9ydEZyb20pIHtcbiAgICAgICAgICBsZXQgZXhwID0gbmV3IFQuRXhwb3J0RnJvbSh7XG4gICAgICAgICAgICBtb2R1bGVTcGVjaWZpZXI6IGl0ZW0ubW9kdWxlU3BlY2lmaWVyLFxuICAgICAgICAgICAgbmFtZWRFeHBvcnRzOiBpdGVtLm5hbWVkRXhwb3J0cy5tYXAoKHsgbmFtZSwgZXhwb3J0ZWROYW1lIH0pID0+IHtcbiAgICAgICAgICAgICAgaWYgKG5hbWUgPT0gbnVsbCkge1xuICAgICAgICAgICAgICAgIHJldHVybiBuZXcgVC5FeHBvcnRTcGVjaWZpZXIoe1xuICAgICAgICAgICAgICAgICAgbmFtZTogZXhwb3J0ZWROYW1lLFxuICAgICAgICAgICAgICAgICAgZXhwb3J0ZWROYW1lLFxuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgIHJldHVybiBuZXcgVC5FeHBvcnRTcGVjaWZpZXIoe1xuICAgICAgICAgICAgICAgIG5hbWUsXG4gICAgICAgICAgICAgICAgZXhwb3J0ZWROYW1lLFxuICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH0pLFxuICAgICAgICAgIH0pO1xuICAgICAgICAgIGJvZHkucHVzaChleHApO1xuICAgICAgICAgIGV4cG9ydHMucHVzaChleHApO1xuICAgICAgICAgIHRoaXMuZXhwb3J0ZWROYW1lcyA9IHRoaXMuZXhwb3J0ZWROYW1lcy5jb25jYXQoXG4gICAgICAgICAgICBleHRyYWN0U3BlY2lmaWVycyhleHApLFxuICAgICAgICAgICk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgZXhwb3J0cy5wdXNoKGl0ZW0pO1xuICAgICAgICAgIGJvZHkucHVzaChpdGVtKTtcbiAgICAgICAgICB0aGlzLmV4cG9ydGVkTmFtZXMgPSB0aGlzLmV4cG9ydGVkTmFtZXMuY29uY2F0KFxuICAgICAgICAgICAgZXh0cmFjdFNwZWNpZmllcnMoaXRlbSksXG4gICAgICAgICAgKTtcbiAgICAgICAgICBpZiAoUy5pc0V4cG9ydERlZmF1bHQoaXRlbSkpIHtcbiAgICAgICAgICAgIHRoaXMuZGVmYXVsdEV4cG9ydCA9IFN5bnRheC5mcm9tSWRlbnRpZmllcignX2RlZmF1bHQnKTtcbiAgICAgICAgICAgIHRoaXMuZXhwb3J0ZWROYW1lcyA9IHRoaXMuZXhwb3J0ZWROYW1lcy5wdXNoKFxuICAgICAgICAgICAgICBFeHBTcGVjKHRoaXMuZGVmYXVsdEV4cG9ydCksXG4gICAgICAgICAgICApO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgYm9keS5wdXNoKGl0ZW0pO1xuICAgICAgfVxuICAgIH1cbiAgICB0aGlzLml0ZW1zID0gTGlzdChib2R5KTtcbiAgICB0aGlzLmltcG9ydHMgPSBMaXN0KGltcG9ydHMpO1xuICAgIHRoaXMuZXhwb3J0cyA9IExpc3QoZXhwb3J0cyk7XG4gICAgdGhpcy5kaXJlY3RpdmVzID0gTGlzdChkaXJlY3RpdmVzKTtcbiAgfVxuXG4gIC8vICRGbG93Rml4TWU6IGZsb3cgZG9lc24ndCBzdXBwb3J0IGNvbXB1dGVkIHByb3BlcnR5IGtleXMgeWV0XG4gIFttZW1vU3ltXSgpIHtcbiAgICBsZXQgcnVudGltZSA9IFtdLFxuICAgICAgY29tcGlsZXRpbWUgPSBbXTtcbiAgICBmb3IgKGxldCBpdGVtIG9mIHRoaXMuaXRlbXMpIHtcbiAgICAgIGlmIChTLmlzRXhwb3J0RGVjbGFyYXRpb24oaXRlbSkpIHtcbiAgICAgICAgaWYgKFMuaXNFeHBvcnREZWZhdWx0KGl0ZW0pKSB7XG4gICAgICAgICAgbGV0IGRlY2wgPSBleHRyYWN0RGVjbGFyYXRpb24oaXRlbSk7XG4gICAgICAgICAgbGV0IGRlZiA9IG5ldyBULkJpbmRpbmdJZGVudGlmaWVyKHtcbiAgICAgICAgICAgIG5hbWU6IHRoaXMuZGVmYXVsdEV4cG9ydCxcbiAgICAgICAgICB9KTtcbiAgICAgICAgICBpZiAoUy5pc0Z1bmN0aW9uRGVjbGFyYXRpb24oZGVjbCkgfHwgUy5pc0NsYXNzRGVjbGFyYXRpb24oZGVjbCkpIHtcbiAgICAgICAgICAgIHJ1bnRpbWUucHVzaChkZWNsKTtcbiAgICAgICAgICAgIC8vIGV4dHJhY3QgbmFtZSBhbmQgYmluZCBpdCB0byBfZGVmYXVsdFxuICAgICAgICAgICAgcnVudGltZS5wdXNoKFxuICAgICAgICAgICAgICBtYWtlVmFyRGVjbFN0bXQoXG4gICAgICAgICAgICAgICAgZGVmLFxuICAgICAgICAgICAgICAgIG5ldyBULklkZW50aWZpZXJFeHByZXNzaW9uKHtcbiAgICAgICAgICAgICAgICAgIG5hbWU6IGRlY2wubmFtZS5uYW1lLFxuICAgICAgICAgICAgICAgIH0pLFxuICAgICAgICAgICAgICApLFxuICAgICAgICAgICAgKTtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgLy8gZXhwcmVzc2lvbiBzbyBiaW5kIGl0IHRvIF9kZWZhdWx0XG4gICAgICAgICAgICBsZXQgc3RtdCA9IG1ha2VWYXJEZWNsU3RtdChkZWYsIGRlY2wpO1xuICAgICAgICAgICAgaWYgKFMuaXNDb21waWxldGltZVN0YXRlbWVudChzdG10KSkge1xuICAgICAgICAgICAgICBjb21waWxldGltZS5wdXNoKHN0bXQpO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgcnVudGltZS5wdXNoKHN0bXQpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgaWYgKFMuaXNDb21waWxldGltZVN0YXRlbWVudChpdGVtKSkge1xuICAgICAgICAgIGNvbXBpbGV0aW1lLnB1c2goaXRlbSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgcnVudGltZS5wdXNoKGl0ZW0pO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICAgIHRoaXMucnVudGltZSA9IExpc3QocnVudGltZSk7XG4gICAgdGhpcy5jb21waWxldGltZSA9IExpc3QoY29tcGlsZXRpbWUpO1xuICB9XG5cbiAgcnVudGltZUl0ZW1zKCkge1xuICAgIGlmICh0aGlzLnJ1bnRpbWUgPT0gbnVsbCkge1xuICAgICAgLy8gJEZsb3dGaXhNZTogZmxvdyBkb2Vzbid0IHN1cHBvcnQgY29tcHV0ZWQgcHJvcGVydHkga2V5cyB5ZXRcbiAgICAgIHRoaXNbbWVtb1N5bV0oKTtcbiAgICB9XG4gICAgcmV0dXJuIHRoaXMucnVudGltZTtcbiAgfVxuXG4gIGNvbXBpbGV0aW1lSXRlbXMoKSB7XG4gICAgaWYgKHRoaXMuY29tcGlsZXRpbWUgPT0gbnVsbCkge1xuICAgICAgLy8gJEZsb3dGaXhNZTogZmxvdyBkb2Vzbid0IHN1cHBvcnQgY29tcHV0ZWQgcHJvcGVydHkga2V5cyB5ZXRcbiAgICAgIHRoaXNbbWVtb1N5bV0oKTtcbiAgICB9XG4gICAgcmV0dXJuIHRoaXMuY29tcGlsZXRpbWU7XG4gIH1cblxuICBwYXJzZSgpIHtcbiAgICByZXR1cm4gbmV3IFQuTW9kdWxlKHtcbiAgICAgIGl0ZW1zOiAodGhpcy5pbXBvcnRzOiBhbnkpLmNvbmNhdCh0aGlzLml0ZW1zKSxcbiAgICAgIGRpcmVjdGl2ZXM6IHRoaXMuZGlyZWN0aXZlcyxcbiAgICAgIC8vICRGbG93Rml4TWU6IGZsb3cgZG9lc24ndCBrbm93IGFib3V0IHJlZHVjZSB5ZXRcbiAgICB9KS5yZWR1Y2UobmV3IFN3ZWV0VG9TaGlmdFJlZHVjZXIoMCkpO1xuICB9XG5cbiAgY29kZWdlbigpIHtcbiAgICByZXR1cm4gY29kZWdlbih0aGlzLnBhcnNlKCkpLmNvZGU7XG4gIH1cbn1cbiJdfQ==