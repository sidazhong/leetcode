'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});

var _immutable = require('immutable');

var _readtable = require('readtable');

var _readIdentifier = require('./read-identifier');

var _readIdentifier2 = _interopRequireDefault(_readIdentifier);

var _readNumeric = require('./read-numeric');

var _readNumeric2 = _interopRequireDefault(_readNumeric);

var _readString = require('./read-string');

var _readString2 = _interopRequireDefault(_readString);

var _readTemplate = require('./read-template');

var _readTemplate2 = _interopRequireDefault(_readTemplate);

var _readRegexp = require('./read-regexp.js');

var _readRegexp2 = _interopRequireDefault(_readRegexp);

var _readComment = require('./read-comment');

var _readComment2 = _interopRequireDefault(_readComment);

var _readDispatch = require('./read-dispatch');

var _tokens = require('../tokens');

var _utils = require('./utils');

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

// use https://github.com/mathiasbynens/regenerate to generate the Unicode code points when implementing modes

function eatWhitespace(stream) {
  stream.readString();
  return _tokens.EmptyToken;
}

const punctuatorTable = Object.keys(_tokens.punctuatorTable).reduce(_utils.insertSequence, {});

function readPunctuator(stream) {
  const len = (0, _utils.retrieveSequenceLength)(punctuatorTable, stream, 0);
  if (len > 0) {
    return new _tokens.PunctuatorToken({
      value: stream.readString(len)
    });
  }
  throw Error('Unknown punctuator');
}

const punctuatorEntries = Object.keys(punctuatorTable).map(p => ({
  key: p,
  mode: 'terminating',
  action: readPunctuator
}));

const whiteSpaceTable = [0x20, 0x09, 0x0b, 0x0c, 0xa0, 0x1680, 0x2000, 0x2001, 0x2002, 0x2003, 0x2004, 0x2005, 0x2006, 0x2007, 0x2008, 0x2009, 0x200a, 0x202f, 0x205f, 0x3000, 0xfeff];

const whiteSpaceEntries = whiteSpaceTable.map(w => ({
  key: w,
  mode: 'terminating',
  action: eatWhitespace
}));

const lineTerminatorTable = [0x0a, 0x0d, 0x2028, 0x2029];

const lineTerminatorEntries = lineTerminatorTable.map(lt => ({
  key: lt,
  mode: 'terminating',
  action: function readLineTerminator(stream) {
    this.incrementLine();
    return eatWhitespace(stream);
  }
}));

const digits = ['0', '1', '2', '3', '4', '5', '6', '7', '8', '9'];

const numericEntries = digits.map(d => ({
  key: d,
  mode: 'non-terminating',
  action: _readNumeric2.default
}));

const quotes = ["'", '"'];

const stringEntries = quotes.map(q => ({
  key: q,
  mode: 'terminating',
  action: _readString2.default
}));

const identifierEntry = {
  mode: 'non-terminating',
  action: _readIdentifier2.default
};

const templateEntry = {
  key: '`',
  mode: 'terminating',
  action: _readTemplate2.default
};

const primitiveReadtable = (0, _readtable.getCurrentReadtable)().extend(...[identifierEntry, ...whiteSpaceEntries, templateEntry, ...punctuatorEntries, ...lineTerminatorEntries, ...numericEntries, ...stringEntries]);

const dotEntry = {
  key: '.',
  mode: 'terminating',
  action: function readDot(stream, ...rest) {
    const nxt = stream.peek(1).charCodeAt(0);
    if ((0, _utils.isDecimalDigit)(nxt)) {
      return (0, _readNumeric2.default)(stream, ...rest);
    }
    return readPunctuator.call(this, stream);
  }
};

const keywordTable = Object.keys(_tokens.keywordTable).reduce(_utils.insertSequence, {});

const keywordEntries = Object.keys(keywordTable).map(k => ({
  key: k,
  mode: 'non-terminating',
  action: function readKeyword(stream) {
    const len = (0, _utils.retrieveSequenceLength)(keywordTable, stream, 0);
    if (len > 0 && !(0, _utils.isIdentifierPart)(stream.peek(len).charCodeAt(0))) {
      return new _tokens.KeywordToken({
        value: stream.readString(len)
      });
    }
    return _readIdentifier2.default.call(this, stream);
  }
}));

const delimiterPairs = [['[', ']'], ['(', ')']];

function readDelimiters(closing, stream, prefix, b) {
  const currentReadtable = (0, _readtable.getCurrentReadtable)();
  (0, _readtable.setCurrentReadtable)(primitiveReadtable);

  let results = _immutable.List.of(this.readToken(stream, (0, _immutable.List)(), b));

  (0, _readtable.setCurrentReadtable)(currentReadtable);
  return this.readUntil(closing, stream, results, b);
}

const delimiterEntries = delimiterPairs.map(p => ({
  key: p[0],
  mode: 'terminating',
  action: function readDefaultDelimiters(stream, prefix, b) {
    return readDelimiters.call(this, p[1], stream, prefix, true);
  }
}));

const bracesEntry = {
  key: '{',
  mode: 'terminating',
  action: function readBraces(stream, prefix, b) {
    const line = this.locationInfo.line;
    const innerB = (0, _utils.isExprPrefix)(line, b, prefix);
    return readDelimiters.call(this, '}', stream, prefix, innerB);
  }
};

function readClosingDelimiter(opening, closing, stream, prefix, b) {
  if (prefix.first().value !== opening) {
    throw Error('Unmatched delimiter:', closing);
  }
  return readPunctuator.call(this, stream);
}

const unmatchedDelimiterEntries = [['{', '}'], ['[', ']'], ['(', ')']].map(p => ({
  key: p[1],
  mode: 'terminating',
  action: function readClosingDelimiters(stream, prefix, b) {
    return readClosingDelimiter.call(this, ...p, stream, prefix, b);
  }
}));

const divEntry = {
  key: '/',
  mode: 'terminating',
  action: function readDiv(stream, prefix, b) {
    let nxt = stream.peek(1);
    if (nxt === '/' || nxt === '*') {
      const result = _readComment2.default.call(this, stream);
      return result;
    }
    if ((0, _utils.isRegexPrefix)(b, prefix)) {
      return _readRegexp2.default.call(this, stream, prefix, b);
    }
    return readPunctuator.call(this, stream);
  }
};

const dispatchBacktickEntry = {
  key: '`',
  mode: 'dispatch',
  action: _readDispatch.readSyntaxTemplate
};

const defaultDispatchEntry = {
  mode: 'dispatch',
  action: function readDefaultDispatch(...args) {
    this.readToken(...args);
    return _tokens.EmptyToken;
  }
};

const dispatchWhiteSpaceEntries = whiteSpaceTable.concat(lineTerminatorTable).map(w => ({
  key: w,
  mode: 'dispatch',
  action: function readDispatchWhitespace(stream, prefix, allowExprs, dispatchKey) {
    this.readToken(stream, prefix, allowExprs);
    return new _tokens.IdentifierToken({ value: dispatchKey });
  }
}));

const atEntry = {
  key: '@',
  mode: 'terminating',
  action: function readAt(stream, prefix) {
    const nxt = stream.peek(1),
          nxtCode = nxt.charCodeAt(0);
    if ((0, _readtable.isEOS)(nxt) || (0, _utils.isWhiteSpace)(nxtCode) || (0, _utils.isLineTerminator)(nxtCode)) {
      return new _tokens.IdentifierToken({ value: stream.readString() });
    }
    throw new SyntaxError('Invalid or unexpected token');
  }
};

const defaultReadtable = primitiveReadtable.extend(...[dotEntry, ...delimiterEntries, ...unmatchedDelimiterEntries, bracesEntry, divEntry, ...keywordEntries, defaultDispatchEntry, dispatchBacktickEntry, ...dispatchWhiteSpaceEntries, atEntry]);

exports.default = defaultReadtable;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9yZWFkZXIvZGVmYXVsdC1yZWFkdGFibGUuanMiXSwibmFtZXMiOlsiZWF0V2hpdGVzcGFjZSIsInN0cmVhbSIsInJlYWRTdHJpbmciLCJwdW5jdHVhdG9yVGFibGUiLCJPYmplY3QiLCJrZXlzIiwicmVkdWNlIiwicmVhZFB1bmN0dWF0b3IiLCJsZW4iLCJ2YWx1ZSIsIkVycm9yIiwicHVuY3R1YXRvckVudHJpZXMiLCJtYXAiLCJwIiwia2V5IiwibW9kZSIsImFjdGlvbiIsIndoaXRlU3BhY2VUYWJsZSIsIndoaXRlU3BhY2VFbnRyaWVzIiwidyIsImxpbmVUZXJtaW5hdG9yVGFibGUiLCJsaW5lVGVybWluYXRvckVudHJpZXMiLCJsdCIsInJlYWRMaW5lVGVybWluYXRvciIsImluY3JlbWVudExpbmUiLCJkaWdpdHMiLCJudW1lcmljRW50cmllcyIsImQiLCJxdW90ZXMiLCJzdHJpbmdFbnRyaWVzIiwicSIsImlkZW50aWZpZXJFbnRyeSIsInRlbXBsYXRlRW50cnkiLCJwcmltaXRpdmVSZWFkdGFibGUiLCJleHRlbmQiLCJkb3RFbnRyeSIsInJlYWREb3QiLCJyZXN0Iiwibnh0IiwicGVlayIsImNoYXJDb2RlQXQiLCJjYWxsIiwia2V5d29yZFRhYmxlIiwia2V5d29yZEVudHJpZXMiLCJrIiwicmVhZEtleXdvcmQiLCJkZWxpbWl0ZXJQYWlycyIsInJlYWREZWxpbWl0ZXJzIiwiY2xvc2luZyIsInByZWZpeCIsImIiLCJjdXJyZW50UmVhZHRhYmxlIiwicmVzdWx0cyIsIm9mIiwicmVhZFRva2VuIiwicmVhZFVudGlsIiwiZGVsaW1pdGVyRW50cmllcyIsInJlYWREZWZhdWx0RGVsaW1pdGVycyIsImJyYWNlc0VudHJ5IiwicmVhZEJyYWNlcyIsImxpbmUiLCJsb2NhdGlvbkluZm8iLCJpbm5lckIiLCJyZWFkQ2xvc2luZ0RlbGltaXRlciIsIm9wZW5pbmciLCJmaXJzdCIsInVubWF0Y2hlZERlbGltaXRlckVudHJpZXMiLCJyZWFkQ2xvc2luZ0RlbGltaXRlcnMiLCJkaXZFbnRyeSIsInJlYWREaXYiLCJyZXN1bHQiLCJkaXNwYXRjaEJhY2t0aWNrRW50cnkiLCJkZWZhdWx0RGlzcGF0Y2hFbnRyeSIsInJlYWREZWZhdWx0RGlzcGF0Y2giLCJhcmdzIiwiZGlzcGF0Y2hXaGl0ZVNwYWNlRW50cmllcyIsImNvbmNhdCIsInJlYWREaXNwYXRjaFdoaXRlc3BhY2UiLCJhbGxvd0V4cHJzIiwiZGlzcGF0Y2hLZXkiLCJhdEVudHJ5IiwicmVhZEF0Iiwibnh0Q29kZSIsIlN5bnRheEVycm9yIiwiZGVmYXVsdFJlYWR0YWJsZSJdLCJtYXBwaW5ncyI6Ijs7Ozs7O0FBRUE7O0FBQ0E7O0FBQ0E7Ozs7QUFDQTs7OztBQUNBOzs7O0FBQ0E7Ozs7QUFDQTs7OztBQUNBOzs7O0FBQ0E7O0FBQ0E7O0FBUUE7Ozs7QUFhQTs7QUFFQSxTQUFTQSxhQUFULENBQXVCQyxNQUF2QixFQUEyQztBQUN6Q0EsU0FBT0MsVUFBUDtBQUNBO0FBQ0Q7O0FBRUQsTUFBTUMsa0JBQWtCQyxPQUFPQyxJQUFQLDBCQUErQkMsTUFBL0Isd0JBRXRCLEVBRnNCLENBQXhCOztBQUtBLFNBQVNDLGNBQVQsQ0FBd0JOLE1BQXhCLEVBQWdDO0FBQzlCLFFBQU1PLE1BQU0sbUNBQXVCTCxlQUF2QixFQUF3Q0YsTUFBeEMsRUFBZ0QsQ0FBaEQsQ0FBWjtBQUNBLE1BQUlPLE1BQU0sQ0FBVixFQUFhO0FBQ1gsV0FBTyw0QkFBb0I7QUFDekJDLGFBQU9SLE9BQU9DLFVBQVAsQ0FBa0JNLEdBQWxCO0FBRGtCLEtBQXBCLENBQVA7QUFHRDtBQUNELFFBQU1FLE1BQU0sb0JBQU4sQ0FBTjtBQUNEOztBQUVELE1BQU1DLG9CQUFvQlAsT0FBT0MsSUFBUCxDQUFZRixlQUFaLEVBQTZCUyxHQUE3QixDQUFpQ0MsTUFBTTtBQUMvREMsT0FBS0QsQ0FEMEQ7QUFFL0RFLFFBQU0sYUFGeUQ7QUFHL0RDLFVBQVFUO0FBSHVELENBQU4sQ0FBakMsQ0FBMUI7O0FBTUEsTUFBTVUsa0JBQWtCLENB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QUNEQyxRQURDLEVBRUQsR0FBR3FCLGdCQUZGLEVBR0QsR0FBR1UseUJBSEYsRUFJRFIsV0FKQyxFQUtEVSxRQUxDLEVBTUQsR0FBR3pCLGNBTkYsRUFPRDZCLG9CQVBDLEVBUURELHFCQVJDLEVBU0QsR0FBR0kseUJBVEYsRUFVREssT0FWQyxDQURvQixDQUF6Qjs7a0JBZWVJLGdCIiwiZmlsZSI6ImRlZmF1bHQtcmVhZHRhYmxlLmpzIiwic291cmNlc0NvbnRlbnQiOlsiLy8gQGZsb3dcblxuaW1wb3J0IHsgTGlzdCB9IGZyb20gJ2ltbXV0YWJsZSc7XG5pbXBvcnQgeyBpc0VPUywgZ2V0Q3VycmVudFJlYWR0YWJsZSwgc2V0Q3VycmVudFJlYWR0YWJsZSB9IGZyb20gJ3JlYWR0YWJsZSc7XG5pbXBvcnQgcmVhZElkZW50aWZpZXIgZnJvbSAnLi9yZWFkLWlkZW50aWZpZXInO1xuaW1wb3J0IHJlYWROdW1lcmljTGl0ZXJhbCBmcm9tICcuL3JlYWQtbnVtZXJpYyc7XG5pbXBvcnQgcmVhZFN0cmluZ0xpdGVyYWwgZnJvbSAnLi9yZWFkLXN0cmluZyc7XG5pbXBvcnQgcmVhZFRlbXBsYXRlTGl0ZXJhbCBmcm9tICcuL3JlYWQtdGVtcGxhdGUnO1xuaW1wb3J0IHJlYWRSZWdFeHAgZnJvbSAnLi9yZWFkLXJlZ2V4cC5qcyc7XG5pbXBvcnQgcmVhZENvbW1lbnQgZnJvbSAnLi9yZWFkLWNvbW1lbnQnO1xuaW1wb3J0IHsgcmVhZFN5bnRheFRlbXBsYXRlIH0gZnJvbSAnLi9yZWFkLWRpc3BhdGNoJztcbmltcG9ydCB7XG4gIHB1bmN0dWF0b3JUYWJsZSBhcyBwdW5jdHVhdG9yTWFwcGluZyxcbiAga2V5d29yZFRhYmxlIGFzIGtleXdvcmRNYXBwaW5nLFxuICBLZXl3b3JkVG9rZW4sXG4gIFB1bmN0dWF0b3JUb2tlbixcbiAgRW1wdHlUb2tlbixcbiAgSWRlbnRpZmllclRva2VuLFxufSBmcm9tICcuLi90b2tlbnMnO1xuaW1wb3J0IHtcbiAgaW5zZXJ0U2VxdWVuY2UsXG4gIHJldHJpZXZlU2VxdWVuY2VMZW5ndGgsXG4gIGlzRXhwclByZWZpeCxcbiAgaXNSZWdleFByZWZpeCxcbiAgaXNJZGVudGlmaWVyUGFydCxcbiAgaXNXaGl0ZVNwYWNlLFxuICBpc0xpbmVUZXJtaW5hdG9yLFxuICBpc0RlY2ltYWxEaWdpdCxcbn0gZnJvbSAnLi91dGlscyc7XG5cbmltcG9ydCB0eXBlIHsgQ2hhclN0cmVhbSB9IGZyb20gJ3JlYWR0YWJsZSc7XG5cbi8vIHVzZSBodHRwczovL2dpdGh1Yi5jb20vbWF0aGlhc2J5bmVucy9yZWdlbmVyYXRlIHRvIGdlbmVyYXRlIHRoZSBVbmljb2RlIGNvZGUgcG9pbnRzIHdoZW4gaW1wbGVtZW50aW5nIG1vZGVzXG5cbmZ1bmN0aW9uIGVhdFdoaXRlc3BhY2Uoc3RyZWFtOiBDaGFyU3RyZWFtKSB7XG4gIHN0cmVhbS5yZWFkU3RyaW5nKCk7XG4gIHJldHVybiBFbXB0eVRva2VuO1xufVxuXG5jb25zdCBwdW5jdHVhdG9yVGFibGUgPSBPYmplY3Qua2V5cyhwdW5jdHVhdG9yTWFwcGluZykucmVkdWNlKFxuICBpbnNlcnRTZXF1ZW5jZSxcbiAge30sXG4pO1xuXG5mdW5jdGlvbiByZWFkUHVuY3R1YXRvcihzdHJlYW0pIHtcbiAgY29uc3QgbGVuID0gcmV0cmlldmVTZXF1ZW5jZUxlbmd0aChwdW5jdHVhdG9yVGFibGUsIHN0cmVhbSwgMCk7XG4gIGlmIChsZW4gPiAwKSB7XG4gICAgcmV0dXJuIG5ldyBQdW5jdHVhdG9yVG9rZW4oe1xuICAgICAgdmFsdWU6IHN0cmVhbS5yZWFkU3RyaW5nKGxlbiksXG4gICAgfSk7XG4gIH1cbiAgdGhyb3cgRXJyb3IoJ1Vua25vd24gcHVuY3R1YXRvcicpO1xufVxuXG5jb25zdCBwdW5jdHVhdG9yRW50cmllcyA9IE9iamVjdC5rZXlzKHB1bmN0dWF0b3JUYWJsZSkubWFwKHAgPT4gKHtcbiAga2V5OiBwLFxuICBtb2RlOiAndGVybWluYXRpbmcnLFxuICBhY3Rpb246IHJlYWRQdW5jdHVhdG9yLFxufSkpO1xuXG5jb25zdCB3aGl0ZVNwYWNlVGFibGUgPSBbXG4gIDB4MjAsXG4gIDB4MDksXG4gIDB4MGIsXG4gIDB4MGMsXG4gIDB4YTAsXG4gIDB4MTY4MCxcbiAgMHgyMDAwLFxuICAweDIwMDEsXG4gIDB4MjAwMixcbiAgMHgyMDAzLFxuICAweDIwMDQsXG4gIDB4MjAwNSxcbiAgMHgyMDA2LFxuICAweDIwMDcsXG4gIDB4MjAwOCxcbiAgMHgyMDA5LFxuICAweDIwMGEsXG4gIDB4MjAyZixcbiAgMHgyMDVmLFxuICAweDMwMDAsXG4gIDB4ZmVmZixcbl07XG5cbmNvbnN0IHdoaXRlU3BhY2VFbnRyaWVzID0gd2hpdGVTcGFjZVRhYmxlLm1hcCh3ID0+ICh7XG4gIGtleTogdyxcbiAgbW9kZTogJ3Rlcm1pbmF0aW5nJyxcbiAgYWN0aW9uOiBlYXRXaGl0ZXNwYWNlLFxufSkpO1xuXG5jb25zdCBsaW5lVGVybWluYXRvclRhYmxlID0gWzB4MGEsIDB4MGQsIDB4MjAyOCwgMHgyMDI5XTtcblxuY29uc3QgbGluZVRlcm1pbmF0b3JFbnRyaWVzID0gbGluZVRlcm1pbmF0b3JUYWJsZS5tYXAobHQgPT4gKHtcbiAga2V5OiBsdCxcbiAgbW9kZTogJ3Rlcm1pbmF0aW5nJyxcbiAgYWN0aW9uOiBmdW5jdGlvbiByZWFkTGluZVRlcm1pbmF0b3Ioc3RyZWFtKSB7XG4gICAgdGhpcy5pbmNyZW1lbnRMaW5lKCk7XG4gICAgcmV0dXJuIGVhdFdoaXRlc3BhY2Uoc3RyZWFtKTtcbiAgfSxcbn0pKTtcblxuY29uc3QgZGlnaXRzID0gWycwJywgJzEnLCAnMicsICczJywgJzQnLCAnNScsICc2JywgJzcnLCAnOCcsICc5J107XG5cbmNvbnN0IG51bWVyaWNFbnRyaWVzID0gZGlnaXRzLm1hcChkID0+ICh7XG4gIGtleTogZCxcbiAgbW9kZTogJ25vbi10ZXJtaW5hdGluZycsXG4gIGFjdGlvbjogcmVhZE51bWVyaWNMaXRlcmFsLFxufSkpO1xuXG5jb25zdCBxdW90ZXMgPSBbXCInXCIsICdcIiddO1xuXG5jb25zdCBzdHJpbmdFbnRyaWVzID0gcXVvdGVzLm1hcChxID0+ICh7XG4gIGtleTogcSxcbiAgbW9kZTogJ3Rlcm1pbmF0aW5nJyxcbiAgYWN0aW9uOiByZWFkU3RyaW5nTGl0ZXJhbCxcbn0pKTtcblxuY29uc3QgaWRlbnRpZmllckVudHJ5ID0ge1xuICBtb2RlOiAnbm9uLXRlcm1pbmF0aW5nJyxcbiAgYWN0aW9uOiByZWFkSWRlbnRpZmllcixcbn07XG5cbmNvbnN0IHRlbXBsYXRlRW50cnkgPSB7XG4gIGtleTogJ2AnLFxuICBtb2RlOiAndGVybWluYXRpbmcnLFxuICBhY3Rpb246IHJlYWRUZW1wbGF0ZUxpdGVyYWwsXG59O1xuXG5jb25zdCBwcmltaXRpdmVSZWFkdGFibGUgPSBnZXRDdXJyZW50UmVhZHRhYmxlKCkuZXh0ZW5kKFxuICAuLi5bXG4gICAgaWRlbnRpZmllckVudHJ5LFxuICAgIC4uLndoaXRlU3BhY2VFbnRyaWVzLFxuICAgIHRlbXBsYXRlRW50cnksXG4gICAgLi4ucHVuY3R1YXRvckVudHJpZXMsXG4gICAgLi4ubGluZVRlcm1pbmF0b3JFbnRyaWVzLFxuICAgIC4uLm51bWVyaWNFbnRyaWVzLFxuICAgIC4uLnN0cmluZ0VudHJpZXMsXG4gIF0sXG4pO1xuXG5jb25zdCBkb3RFbnRyeSA9IHtcbiAga2V5OiAnLicsXG4gIG1vZGU6ICd0ZXJtaW5hdGluZycsXG4gIGFjdGlvbjogZnVuY3Rpb24gcmVhZERvdChzdHJlYW0sIC4uLnJlc3QpIHtcbiAgICBjb25zdCBueHQgPSBzdHJlYW0ucGVlaygxKS5jaGFyQ29kZUF0KDApO1xuICAgIGlmIChpc0RlY2ltYWxEaWdpdChueHQpKSB7XG4gICAgICByZXR1cm4gcmVhZE51bWVyaWNMaXRlcmFsKHN0cmVhbSwgLi4ucmVzdCk7XG4gICAgfVxuICAgIHJldHVybiByZWFkUHVuY3R1YXRvci5jYWxsKHRoaXMsIHN0cmVhbSk7XG4gIH0sXG59O1xuXG5jb25zdCBrZXl3b3JkVGFibGUgPSBPYmplY3Qua2V5cyhrZXl3b3JkTWFwcGluZykucmVkdWNlKGluc2VydFNlcXVlbmNlLCB7fSk7XG5cbmNvbnN0IGtleXdvcmRFbnRyaWVzID0gT2JqZWN0LmtleXMoa2V5d29yZFRhYmxlKS5tYXAoayA9PiAoe1xuICBrZXk6IGssXG4gIG1vZGU6ICdub24tdGVybWluYXRpbmcnLFxuICBhY3Rpb246IGZ1bmN0aW9uIHJlYWRLZXl3b3JkKHN0cmVhbSkge1xuICAgIGNvbnN0IGxlbiA9IHJldHJpZXZlU2VxdWVuY2VMZW5ndGgoa2V5d29yZFRhYmxlLCBzdHJlYW0sIDApO1xuICAgIGlmIChsZW4gPiAwICYmICFpc0lkZW50aWZpZXJQYXJ0KHN0cmVhbS5wZWVrKGxlbikuY2hhckNvZGVBdCgwKSkpIHtcbiAgICAgIHJldHVybiBuZXcgS2V5d29yZFRva2VuKHtcbiAgICAgICAgdmFsdWU6IHN0cmVhbS5yZWFkU3RyaW5nKGxlbiksXG4gICAgICB9KTtcbiAgICB9XG4gICAgcmV0dXJuIHJlYWRJZGVudGlmaWVyLmNhbGwodGhpcywgc3RyZWFtKTtcbiAgfSxcbn0pKTtcblxuY29uc3QgZGVsaW1pdGVyUGFpcnMgPSBbWydbJywgJ10nXSwgWycoJywgJyknXV07XG5cbmZ1bmN0aW9uIHJlYWREZWxpbWl0ZXJzKGNsb3NpbmcsIHN0cmVhbSwgcHJlZml4LCBiKSB7XG4gIGNvbnN0IGN1cnJlbnRSZWFkdGFibGUgPSBnZXRDdXJyZW50UmVhZHRhYmxlKCk7XG4gIHNldEN1cnJlbnRSZWFkdGFibGUocHJpbWl0aXZlUmVhZHRhYmxlKTtcblxuICBsZXQgcmVzdWx0cyA9IExpc3Qub2YodGhpcy5yZWFkVG9rZW4oc3RyZWFtLCBMaXN0KCksIGIpKTtcblxuICBzZXRDdXJyZW50UmVhZHRhYmxlKGN1cnJlbnRSZWFkdGFibGUpO1xuICByZXR1cm4gdGhpcy5yZWFkVW50aWwoY2xvc2luZywgc3RyZWFtLCByZXN1bHRzLCBiKTtcbn1cblxuY29uc3QgZGVsaW1pdGVyRW50cmllcyA9IGRlbGltaXRlclBhaXJzLm1hcChwID0+ICh7XG4gIGtleTogcFswXSxcbiAgbW9kZTogJ3Rlcm1pbmF0aW5nJyxcbiAgYWN0aW9uOiBmdW5jdGlvbiByZWFkRGVmYXVsdERlbGltaXRlcnMoc3RyZWFtLCBwcmVmaXgsIGIpIHtcbiAgICByZXR1cm4gcmVhZERlbGltaXRlcnMuY2FsbCh0aGlzLCBwWzFdLCBzdHJlYW0sIHByZWZpeCwgdHJ1ZSk7XG4gIH0sXG59KSk7XG5cbmNvbnN0IGJyYWNlc0VudHJ5ID0ge1xuICBrZXk6ICd7JyxcbiAgbW9kZTogJ3Rlcm1pbmF0aW5nJyxcbiAgYWN0aW9uOiBmdW5jdGlvbiByZWFkQnJhY2VzKHN0cmVhbSwgcHJlZml4LCBiKSB7XG4gICAgY29uc3QgbGluZSA9IHRoaXMubG9jYXRpb25JbmZvLmxpbmU7XG4gICAgY29uc3QgaW5uZXJCID0gaXNFeHByUHJlZml4KGxpbmUsIGIsIHByZWZpeCk7XG4gICAgcmV0dXJuIHJlYWREZWxpbWl0ZXJzLmNhbGwodGhpcywgJ30nLCBzdHJlYW0sIHByZWZpeCwgaW5uZXJCKTtcbiAgfSxcbn07XG5cbmZ1bmN0aW9uIHJlYWRDbG9zaW5nRGVsaW1pdGVyKG9wZW5pbmcsIGNsb3NpbmcsIHN0cmVhbSwgcHJlZml4LCBiKSB7XG4gIGlmIChwcmVmaXguZmlyc3QoKS52YWx1ZSAhPT0gb3BlbmluZykge1xuICAgIHRocm93IEVycm9yKCdVbm1hdGNoZWQgZGVsaW1pdGVyOicsIGNsb3NpbmcpO1xuICB9XG4gIHJldHVybiByZWFkUHVuY3R1YXRvci5jYWxsKHRoaXMsIHN0cmVhbSk7XG59XG5cbmNvbnN0IHVubWF0Y2hlZERlbGltaXRlckVudHJpZXMgPSBbXG4gIFsneycsICd9J10sXG4gIFsnWycsICddJ10sXG4gIFsnKCcsICcpJ10sXG5dLm1hcChwID0+ICh7XG4gIGtleTogcFsxXSxcbiAgbW9kZTogJ3Rlcm1pbmF0aW5nJyxcbiAgYWN0aW9uOiBmdW5jdGlvbiByZWFkQ2xvc2luZ0RlbGltaXRlcnMoc3RyZWFtLCBwcmVmaXgsIGIpIHtcbiAgICByZXR1cm4gcmVhZENsb3NpbmdEZWxpbWl0ZXIuY2FsbCh0aGlzLCAuLi5wLCBzdHJlYW0sIHByZWZpeCwgYik7XG4gIH0sXG59KSk7XG5cbmNvbnN0IGRpdkVudHJ5ID0ge1xuICBrZXk6ICcvJyxcbiAgbW9kZTogJ3Rlcm1pbmF0aW5nJyxcbiAgYWN0aW9uOiBmdW5jdGlvbiByZWFkRGl2KHN0cmVhbSwgcHJlZml4LCBiKSB7XG4gICAgbGV0IG54dCA9IHN0cmVhbS5wZWVrKDEpO1xuICAgIGlmIChueHQgPT09ICcvJyB8fCBueHQgPT09ICcqJykge1xuICAgICAgY29uc3QgcmVzdWx0ID0gcmVhZENvbW1lbnQuY2FsbCh0aGlzLCBzdHJlYW0pO1xuICAgICAgcmV0dXJuIHJlc3VsdDtcbiAgICB9XG4gICAgaWYgKGlzUmVnZXhQcmVmaXgoYiwgcHJlZml4KSkge1xuICAgICAgcmV0dXJuIHJlYWRSZWdFeHAuY2FsbCh0aGlzLCBzdHJlYW0sIHByZWZpeCwgYik7XG4gICAgfVxuICAgIHJldHVybiByZWFkUHVuY3R1YXRvci5jYWxsKHRoaXMsIHN0cmVhbSk7XG4gIH0sXG59O1xuXG5jb25zdCBkaXNwYXRjaEJhY2t0aWNrRW50cnkgPSB7XG4gIGtleTogJ2AnLFxuICBtb2RlOiAnZGlzcGF0Y2gnLFxuICBhY3Rpb246IHJlYWRTeW50YXhUZW1wbGF0ZSxcbn07XG5cbmNvbnN0IGRlZmF1bHREaXNwYXRjaEVudHJ5ID0ge1xuICBtb2RlOiAnZGlzcGF0Y2gnLFxuICBhY3Rpb246IGZ1bmN0aW9uIHJlYWREZWZhdWx0RGlzcGF0Y2goLi4uYXJncykge1xuICAgIHRoaXMucmVhZFRva2VuKC4uLmFyZ3MpO1xuICAgIHJldHVybiBFbXB0eVRva2VuO1xuICB9LFxufTtcblxuY29uc3QgZGlzcGF0Y2hXaGl0ZVNwYWNlRW50cmllcyA9IHdoaXRlU3BhY2VUYWJsZVxuICAuY29uY2F0KGxpbmVUZXJtaW5hdG9yVGFibGUpXG4gIC5tYXAodyA9PiAoe1xuICAgIGtleTogdyxcbiAgICBtb2RlOiAnZGlzcGF0Y2gnLFxuICAgIGFjdGlvbjogZnVuY3Rpb24gcmVhZERpc3BhdGNoV2hpdGVzcGFjZShcbiAgICAgIHN0cmVhbSxcbiAgICAgIHByZWZpeCxcbiAgICAgIGFsbG93RXhwcnMsXG4gICAgICBkaXNwYXRjaEtleSxcbiAgICApIHtcbiAgICAgIHRoaXMucmVhZFRva2VuKHN0cmVhbSwgcHJlZml4LCBhbGxvd0V4cHJzKTtcbiAgICAgIHJldHVybiBuZXcgSWRlbnRpZmllclRva2VuKHsgdmFsdWU6IGRpc3BhdGNoS2V5IH0pO1xuICAgIH0sXG4gIH0pKTtcblxuY29uc3QgYXRFbnRyeSA9IHtcbiAga2V5OiAnQCcsXG4gIG1vZGU6ICd0ZXJtaW5hdGluZycsXG4gIGFjdGlvbjogZnVuY3Rpb24gcmVhZEF0KHN0cmVhbSwgcHJlZml4KSB7XG4gICAgY29uc3Qgbnh0ID0gc3RyZWFtLnBlZWsoMSksXG4gICAgICBueHRDb2RlID0gbnh0LmNoYXJDb2RlQXQoMCk7XG4gICAgaWYgKGlzRU9TKG54dCkgfHwgaXNXaGl0ZVNwYWNlKG54dENvZGUpIHx8IGlzTGluZVRlcm1pbmF0b3Iobnh0Q29kZSkpIHtcbiAgICAgIHJldHVybiBuZXcgSWRlbnRpZmllclRva2VuKHsgdmFsdWU6IHN0cmVhbS5yZWFkU3RyaW5nKCkgfSk7XG4gICAgfVxuICAgIHRocm93IG5ldyBTeW50YXhFcnJvcignSW52YWxpZCBvciB1bmV4cGVjdGVkIHRva2VuJyk7XG4gIH0sXG59O1xuXG5jb25zdCBkZWZhdWx0UmVhZHRhYmxlID0gcHJpbWl0aXZlUmVhZHRhYmxlLmV4dGVuZChcbiAgLi4uW1xuICAgIGRvdEVudHJ5LFxuICAgIC4uLmRlbGltaXRlckVudHJpZXMsXG4gICAgLi4udW5tYXRjaGVkRGVsaW1pdGVyRW50cmllcyxcbiAgICBicmFjZXNFbnRyeSxcbiAgICBkaXZFbnRyeSxcbiAgICAuLi5rZXl3b3JkRW50cmllcyxcbiAgICBkZWZhdWx0RGlzcGF0Y2hFbnRyeSxcbiAgICBkaXNwYXRjaEJhY2t0aWNrRW50cnksXG4gICAgLi4uZGlzcGF0Y2hXaGl0ZVNwYWNlRW50cmllcyxcbiAgICBhdEVudHJ5LFxuICBdLFxuKTtcblxuZXhwb3J0IGRlZmF1bHQgZGVmYXVsdFJlYWR0YWJsZTtcbiJdfQ==