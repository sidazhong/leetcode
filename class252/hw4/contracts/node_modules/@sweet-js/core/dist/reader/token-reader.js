'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.getSlice = getSlice;
exports.default = read;

var _readtable = require('readtable');

var _defaultReadtable = require('./default-readtable');

var _defaultReadtable2 = _interopRequireDefault(_defaultReadtable);

var _immutable = require('immutable');

var _tokens = require('../tokens');

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

(0, _readtable.setCurrentReadtable)(_defaultReadtable2.default);

function getSlice(stream, startLocation) {
  return {
    text: stream.getSlice(startLocation.position),
    start: startLocation.position,
    startLocation,
    end: stream.sourceInfo.position
  };
}

const streams = new WeakMap();

class ReadError extends Error {
  constructor({
    index,
    line,
    column,
    message
  }) {
    super(message);
    this.index = index;
    this.line = line;
    this.column = column;
    this.message = `[${line}:${column}] ${message}`;
  }
}

class TokenReader extends _readtable.Reader {
  constructor(stream, context) {
    super();
    this.context = context;
    streams.set(this, stream);
    this.locationInfo = {
      line: 1,
      column: 1
    };
  }

  createError(msg) {
    let message = msg.replace(/\{(\d+)\}/g, (_, n) => JSON.stringify(arguments[+n + 1]));
    return new ReadError({
      message,
      // $FlowFixMe: decide on how to handle possible nullability
      index: streams.get(this).sourceInfo.position,
      line: this.locationInfo.line,
      column: this.locationInfo.column
    });
  }

  createILLEGAL(char) {
    return !(0, _readtable.isEOS)(char) ? this.createError('Unexpected {0}', char) : this.createError('Unexpected end of input');
  }

  readToken(stream, ...rest) {
    const startLocation = Object.assign({}, this.locationInfo, stream.sourceInfo);
    const result = super.read(stream, ...rest);

    if (startLocation.column === this.locationInfo.column && startLocation.line === this.locationInfo.line) {
      this.locationInfo.column += stream.sourceInfo.position - startLocation.position;
    }

    if (result === _tokens.EmptyToken) return result;

    if (!_immutable.List.isList(result)) result.slice = getSlice(stream, startLocation);

    return result;
  }

  readUntil(close, stream, prefix, exprAllowed) {
    let result,
        results = prefix,
        done = false;
    do {
      if ((0, _readtable.isEOS)(stream.peek())) break;
      done = typeof close === 'function' ? close() : stream.peek() === close;
      result = this.readToken(stream, results, exprAllowed);

      if (result !== _tokens.EmptyToken) {
        results = results.push(result);
      }
    } while (!done);
    return results;
  }

  incrementLine() {
    this.locationInfo.line += 1;
    this.locationInfo.column = 1;
  }
}

function read(source, context) {
  const stream = typeof source === 'string' ? new _readtable.CharStream(source) : source;
  if ((0, _readtable.isEOS)(stream.peek())) return (0, _immutable.List)();
  return new TokenReader(stream, context).readUntil(null, stream, (0, _immutable.List)(), false);
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9yZWFkZXIvdG9rZW4tcmVhZGVyLmpzIl0sIm5hbWVzIjpbImdldFNsaWNlIiwicmVhZCIsInN0cmVhbSIsInN0YXJ0TG9jYXRpb24iLCJ0ZXh0IiwicG9zaXRpb24iLCJzdGFydCIsImVuZCIsInNvdXJjZUluZm8iLCJzdHJlYW1zIiwiV2Vha01hcCIsIlJlYWRFcnJvciIsIkVycm9yIiwiY29uc3RydWN0b3IiLCJpbmRleCIsImxpbmUiLCJjb2x1bW4iLCJtZXNzYWdlIiwiVG9rZW5SZWFkZXIiLCJjb250ZXh0Iiwic2V0IiwibG9jYXRpb25JbmZvIiwiY3JlYXRlRXJyb3IiLCJtc2ciLCJyZXBsYWNlIiwiXyIsIm4iLCJKU09OIiwic3RyaW5naWZ5IiwiYXJndW1lbnRzIiwiZ2V0IiwiY3JlYXRlSUxMRUdBTCIsImNoYXIiLCJyZWFkVG9rZW4iLCJyZXN0IiwiT2JqZWN0IiwiYXNzaWduIiwicmVzdWx0IiwiaXNMaXN0Iiwic2xpY2UiLCJyZWFkVW50aWwiLCJjbG9zZSIsInByZWZpeCIsImV4cHJBbGxvd2VkIiwicmVzdWx0cyIsImRvbmUiLCJwZWVrIiwicHVzaCIsImluY3JlbWVudExpbmUiLCJzb3VyY2UiXSwibWFwcGluZ3MiOiI7Ozs7O1FBcUJnQkEsUSxHQUFBQSxRO2tCQXdIUUMsSTs7QUEzSXhCOztBQUNBOzs7O0FBQ0E7O0FBQ0E7Ozs7QUFJQTs7QUFZTyxTQUFTRCxRQUFULENBQ0xFLE1BREssRUFFTEMsYUFGSyxFQUdFO0FBQ1AsU0FBTztBQUNMQyxVQUFNRixPQUFPRixRQUFQLENBQWdCRyxjQUFjRSxRQUE5QixDQUREO0FBRUxDLFdBQU9ILGNBQWNFLFFBRmhCO0FBR0xGLGlCQUhLO0FBSUxJLFNBQUtMLE9BQU9NLFVBQVAsQ0FBa0JIO0FBSmxCLEdBQVA7QUFNRDs7QUFFRCxNQUFNSSxVQUFVLElBQUlDLE9BQUosRUFBaEI7O0FBRUEsTUFBTUMsU0FBTixTQUF3QkMsS0FBeEIsQ0FBOEI7QUFLNUJDLGNBQVk7QUFD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QUEyQjtBQUN6Qk8sa0JBQVVBLFFBQVFHLElBQVIsQ0FBYVYsTUFBYixDQUFWO0FBQ0Q7QUFDRixLQVJELFFBUVMsQ0FBQ1EsSUFSVjtBQVNBLFdBQU9ELE9BQVA7QUFDRDs7QUFFREksa0JBQXNCO0FBQ3BCLFNBQUszQixZQUFMLENBQWtCTixJQUFsQixJQUEwQixDQUExQjtBQUNBLFNBQUtNLFlBQUwsQ0FBa0JMLE1BQWxCLEdBQTJCLENBQTNCO0FBQ0Q7QUEvRThCOztBQWtGbEIsU0FBU2YsSUFBVCxDQUNiZ0QsTUFEYSxFQUViOUIsT0FGYSxFQUdGO0FBQ1gsUUFBTWpCLFNBQVMsT0FBTytDLE1BQVAsS0FBa0IsUUFBbEIsR0FBNkIsMEJBQWVBLE1BQWYsQ0FBN0IsR0FBc0RBLE1BQXJFO0FBQ0EsTUFBSSxzQkFBTS9DLE9BQU80QyxJQUFQLEVBQU4sQ0FBSixFQUEwQixPQUFPLHNCQUFQO0FBQzFCLFNBQU8sSUFBSTVCLFdBQUosQ0FBZ0JoQixNQUFoQixFQUF3QmlCLE9BQXhCLEVBQWlDcUIsU0FBakMsQ0FDTCxJQURLLEVBRUx0QyxNQUZLLEVBR0wsc0JBSEssRUFJTCxLQUpLLENBQVA7QUFNRCIsImZpbGUiOiJ0b2tlbi1yZWFkZXIuanMiLCJzb3VyY2VzQ29udGVudCI6WyIvLyBAZmxvd1xuXG5pbXBvcnQgeyBDaGFyU3RyZWFtLCBpc0VPUywgUmVhZGVyLCBzZXRDdXJyZW50UmVhZHRhYmxlIH0gZnJvbSAncmVhZHRhYmxlJztcbmltcG9ydCBkZWZhdWx0UmVhZHRhYmxlIGZyb20gJy4vZGVmYXVsdC1yZWFkdGFibGUnO1xuaW1wb3J0IHsgTGlzdCB9IGZyb20gJ2ltbXV0YWJsZSc7XG5pbXBvcnQgeyBFbXB0eVRva2VuIH0gZnJvbSAnLi4vdG9rZW5zJztcblxuaW1wb3J0IHR5cGUgeyBTdGFydExvY2F0aW9uLCBTbGljZSB9IGZyb20gJy4uL3Rva2Vucyc7XG5cbnNldEN1cnJlbnRSZWFkdGFibGUoZGVmYXVsdFJlYWR0YWJsZSk7XG5cbmV4cG9ydCB0eXBlIExvY2F0aW9uSW5mbyA9IHtcbiAgbGluZTogbnVtYmVyLFxuICBjb2x1bW46IG51bWJlcixcbn07XG5cbnR5cGUgQ29udGV4dCA9IHtcbiAgYmluZGluZ3M6IGFueSxcbiAgc2NvcGVzZXRzOiBhbnksXG59O1xuXG5leHBvcnQgZnVuY3Rpb24gZ2V0U2xpY2UoXG4gIHN0cmVhbTogQ2hhclN0cmVhbSxcbiAgc3RhcnRMb2NhdGlvbjogU3RhcnRMb2NhdGlvbixcbik6IFNsaWNlIHtcbiAgcmV0dXJuIHtcbiAgICB0ZXh0OiBzdHJlYW0uZ2V0U2xpY2Uoc3RhcnRMb2NhdGlvbi5wb3NpdGlvbiksXG4gICAgc3RhcnQ6IHN0YXJ0TG9jYXRpb24ucG9zaXRpb24sXG4gICAgc3RhcnRMb2NhdGlvbixcbiAgICBlbmQ6IHN0cmVhbS5zb3VyY2VJbmZvLnBvc2l0aW9uLFxuICB9O1xufVxuXG5jb25zdCBzdHJlYW1zID0gbmV3IFdlYWtNYXAoKTtcblxuY2xhc3MgUmVhZEVycm9yIGV4dGVuZHMgRXJyb3Ige1xuICBpbmRleDogbnVtYmVyO1xuICBsaW5lOiBudW1iZXI7XG4gIGNvbHVtbjogbnVtYmVyO1xuICBtZXNzYWdlOiBzdHJpbmc7XG4gIGNvbnN0cnVjdG9yKHtcbiAgICBpbmRleCxcbiAgICBsaW5lLFxuICAgIGNvbHVtbixcbiAgICBtZXNzYWdlLFxuICB9OiB7XG4gICAgaW5kZXg6IG51bWJlcixcbiAgICBsaW5lOiBudW1iZXIsXG4gICAgY29sdW1uOiBudW1iZXIsXG4gICAgbWVzc2FnZTogc3RyaW5nLFxuICB9KSB7XG4gICAgc3VwZXIobWVzc2FnZSk7XG4gICAgdGhpcy5pbmRleCA9IGluZGV4O1xuICAgIHRoaXMubGluZSA9IGxpbmU7XG4gICAgdGhpcy5jb2x1bW4gPSBjb2x1bW47XG4gICAgdGhpcy5tZXNzYWdlID0gYFske2xpbmV9OiR7Y29sdW1ufV0gJHttZXNzYWdlfWA7XG4gIH1cbn1cblxuY2xhc3MgVG9rZW5SZWFkZXIgZXh0ZW5kcyBSZWFkZXIge1xuICBsb2NhdGlvbkluZm86IExvY2F0aW9uSW5mbztcbiAgY29udGV4dDogP0NvbnRleHQ7XG4gIGNvbnN0cnVjdG9yKHN0cmVhbTogQ2hhclN0cmVhbSwgY29udGV4dD86IENvbnRleHQpIHtcbiAgICBzdXBlcigpO1xuICAgIHRoaXMuY29udGV4dCA9IGNvbnRleHQ7XG4gICAgc3RyZWFtcy5zZXQodGhpcywgc3RyZWFtKTtcbiAgICB0aGlzLmxvY2F0aW9uSW5mbyA9IHtcbiAgICAgIGxpbmU6IDEsXG4gICAgICBjb2x1bW46IDEsXG4gICAgfTtcbiAgfVxuXG4gIGNyZWF0ZUVycm9yKG1zZzogc3RyaW5nKTogUmVhZEVycm9yIHtcbiAgICBsZXQgbWVzc2FnZSA9IG1zZy5yZXBsYWNlKC9cXHsoXFxkKylcXH0vZywgKF8sIG4pID0+XG4gICAgICBKU09OLnN0cmluZ2lmeShhcmd1bWVudHNbK24gKyAxXSksXG4gICAgKTtcbiAgICByZXR1cm4gbmV3IFJlYWRFcnJvcih7XG4gICAgICBtZXNzYWdlLFxuICAgICAgLy8gJEZsb3dGaXhNZTogZGVjaWRlIG9uIGhvdyB0byBoYW5kbGUgcG9zc2libGUgbnVsbGFiaWxpdHlcbiAgICAgIGluZGV4OiBzdHJlYW1zLmdldCh0aGlzKS5zb3VyY2VJbmZvLnBvc2l0aW9uLFxuICAgICAgbGluZTogdGhpcy5sb2NhdGlvbkluZm8ubGluZSxcbiAgICAgIGNvbHVtbjogdGhpcy5sb2NhdGlvbkluZm8uY29sdW1uLFxuICAgIH0pO1xuICB9XG5cbiAgY3JlYXRlSUxMRUdBTChjaGFyKSB7XG4gICAgcmV0dXJuICFpc0VPUyhjaGFyKVxuICAgICAgPyB0aGlzLmNyZWF0ZUVycm9yKCdVbmV4cGVjdGVkIHswfScsIGNoYXIpXG4gICAgICA6IHRoaXMuY3JlYXRlRXJyb3IoJ1VuZXhwZWN0ZWQgZW5kIG9mIGlucHV0Jyk7XG4gIH1cblxuICByZWFkVG9rZW4oc3RyZWFtOiBDaGFyU3RyZWFtLCAuLi5yZXN0OiBBcnJheTxhbnk+KSB7XG4gICAgY29uc3Qgc3RhcnRMb2NhdGlvbiA9IE9iamVjdC5hc3NpZ24oXG4gICAgICB7fSxcbiAgICAgIHRoaXMubG9jYXRpb25JbmZvLFxuICAgICAgc3RyZWFtLnNvdXJjZUluZm8sXG4gICAgKTtcbiAgICBjb25zdCByZXN1bHQgPSBzdXBlci5yZWFkKHN0cmVhbSwgLi4ucmVzdCk7XG5cbiAgICBpZiAoXG4gICAgICBzdGFydExvY2F0aW9uLmNvbHVtbiA9PT0gdGhpcy5sb2NhdGlvbkluZm8uY29sdW1uICYmXG4gICAgICBzdGFydExvY2F0aW9uLmxpbmUgPT09IHRoaXMubG9jYXRpb25JbmZvLmxpbmVcbiAgICApIHtcbiAgICAgIHRoaXMubG9jYXRpb25JbmZvLmNvbHVtbiArPVxuICAgICAgICBzdHJlYW0uc291cmNlSW5mby5wb3NpdGlvbiAtIHN0YXJ0TG9jYXRpb24ucG9zaXRpb247XG4gICAgfVxuXG4gICAgaWYgKHJlc3VsdCA9PT0gRW1wdHlUb2tlbikgcmV0dXJuIHJlc3VsdDtcblxuICAgIGlmICghTGlzdC5pc0xpc3QocmVzdWx0KSkgcmVzdWx0LnNsaWNlID0gZ2V0U2xpY2Uoc3RyZWFtLCBzdGFydExvY2F0aW9uKTtcblxuICAgIHJldHVybiByZXN1bHQ7XG4gIH1cblxuICByZWFkVW50aWwoXG4gICAgY2xvc2U6ID9GdW5jdGlvbiB8ID9zdHJpbmcsXG4gICAgc3RyZWFtOiBDaGFyU3RyZWFtLFxuICAgIHByZWZpeDogTGlzdDxhbnk+LFxuICAgIGV4cHJBbGxvd2VkOiBib29sZWFuLFxuICApOiBMaXN0PGFueT4ge1xuICAgIGxldCByZXN1bHQsXG4gICAgICByZXN1bHRzID0gcHJlZml4LFxuICAgICAgZG9uZSA9IGZhbHNlO1xuICAgIGRvIHtcbiAgICAgIGlmIChpc0VPUyhzdHJlYW0ucGVlaygpKSkgYnJlYWs7XG4gICAgICBkb25lID0gdHlwZW9mIGNsb3NlID09PSAnZnVuY3Rpb24nID8gY2xvc2UoKSA6IHN0cmVhbS5wZWVrKCkgPT09IGNsb3NlO1xuICAgICAgcmVzdWx0ID0gdGhpcy5yZWFkVG9rZW4oc3RyZWFtLCByZXN1bHRzLCBleHByQWxsb3dlZCk7XG5cbiAgICAgIGlmIChyZXN1bHQgIT09IEVtcHR5VG9rZW4pIHtcbiAgICAgICAgcmVzdWx0cyA9IHJlc3VsdHMucHVzaChyZXN1bHQpO1xuICAgICAgfVxuICAgIH0gd2hpbGUgKCFkb25lKTtcbiAgICByZXR1cm4gcmVzdWx0cztcbiAgfVxuXG4gIGluY3JlbWVudExpbmUoKTogdm9pZCB7XG4gICAgdGhpcy5sb2NhdGlvbkluZm8ubGluZSArPSAxO1xuICAgIHRoaXMubG9jYXRpb25JbmZvLmNvbHVtbiA9IDE7XG4gIH1cbn1cblxuZXhwb3J0IGRlZmF1bHQgZnVuY3Rpb24gcmVhZChcbiAgc291cmNlOiBzdHJpbmcgfCBDaGFyU3RyZWFtLFxuICBjb250ZXh0PzogQ29udGV4dCxcbik6IExpc3Q8YW55PiB7XG4gIGNvbnN0IHN0cmVhbSA9IHR5cGVvZiBzb3VyY2UgPT09ICdzdHJpbmcnID8gbmV3IENoYXJTdHJlYW0oc291cmNlKSA6IHNvdXJjZTtcbiAgaWYgKGlzRU9TKHN0cmVhbS5wZWVrKCkpKSByZXR1cm4gTGlzdCgpO1xuICByZXR1cm4gbmV3IFRva2VuUmVhZGVyKHN0cmVhbSwgY29udGV4dCkucmVhZFVudGlsKFxuICAgIG51bGwsXG4gICAgc3RyZWFtLFxuICAgIExpc3QoKSxcbiAgICBmYWxzZSxcbiAgKTtcbn1cbiJdfQ==