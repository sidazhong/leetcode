'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = readNumericLiteral;

var _readtable = require('readtable');

var _esutils = require('esutils');

var _utils = require('./utils');

var _tokens = require('../tokens');

const {
  isIdentifierPartES6: isIdentifierPart,
  isIdentifierStartES6: isIdentifierStart
} = _esutils.code;

let terminates;

function readNumericLiteral(stream) {
  terminates = (0, _utils.isTerminating)((0, _readtable.getCurrentReadtable)());
  let idx = 0,
      char = stream.peek();

  if (char === '0') {
    char = stream.peek(++idx);
    if (!(0, _readtable.isEOS)(char)) {
      char = char.toLowerCase();
      switch (char) {
        case 'x':
          return readHexLiteral.call(this, stream);
        case 'b':
          return readBinaryLiteral.call(this, stream);
        case 'o':
          return readOctalLiteral.call(this, stream);
        default:
          if (isDecimalChar(char)) {
            return readLegacyOctalLiteral.call(this, stream); // reads legacy octal and decimal
          }
      }
    } else {
      return new _tokens.NumericToken({
        value: +stream.readString()
      });
    }
  } else if (char !== '.') {
    while (!terminates(char) && isDecimalChar(char)) {
      char = stream.peek(++idx);
    }
    if ((0, _readtable.isEOS)(char)) {
      return new _tokens.NumericToken({
        value: +stream.readString(idx)
      });
    }
  }

  idx = addDecimalLiteralSuffixLength.call(this, stream, idx);

  char = stream.peek(idx);
  if (!(0, _readtable.isEOS)(char) && !terminates(char) && isIdentifierStart(char)) {
    throw this.createILLEGAL(char);
  }

  return new _tokens.NumericToken({
    value: +stream.readString(idx)
  });
}

function addDecimalLiteralSuffixLength(stream, idx) {
  let char = stream.peek(idx);
  if (char === '.') {
    char = stream.peek(++idx);
    if ((0, _readtable.isEOS)(char)) return idx;

    while (isDecimalChar(char)) {
      char = stream.peek(++idx);
      if (terminates(char) || (0, _readtable.isEOS)(char)) return idx;
    }
  }

  if (char.toLowerCase() === 'e') {
    char = stream.peek(++idx);
    if ((0, _readtable.isEOS)(char)) throw this.createILLEGAL(char);

    if (char === '+' || char === '-') {
      char = stream.peek(++idx);
      if ((0, _readtable.isEOS)(char)) throw this.createILLEGAL(char);
    }

    while (isDecimalChar(char)) {
      char = stream.peek(++idx);
      if (terminates(char) || (0, _readtable.isEOS)(char)) break;
    }
  }
  return idx;
}

function readLegacyOctalLiteral(stream) {
  let idx = 0,
      isOctal = true,
      char = stream.peek();

  while (!terminates(char) && !(0, _readtable.isEOS)(char)) {
    if ('0' <= char && char <= '7') {
      idx++;
    } else if (char === '8' || char === '9') {
      isOctal = false;
      idx++;
    } else if (isIdentifierPart(char.charCodeAt(0))) {
      throw this.createILLEGAL(char);
    } else {
      break;
    }

    char = stream.peek(idx);
  }

  if (!isOctal) return new _tokens.NumericToken({
    value: parseNumeric(stream, idx, 10),
    octal: true,
    noctal: !isOctal
  });

  return new _tokens.NumericToken({
    value: parseNumeric(stream, idx, 8),
    octal: true,
    noctal: !isOctal
  });
}

function readOctalLiteral(stream) {
  let start,
      idx = start = 2,
      char = stream.peek(idx);
  while (!terminates(char) && !(0, _readtable.isEOS)(char)) {
    if ('0' <= char && char <= '7') {
      char = stream.peek(++idx);
    } else if (isIdentifierPart(char.charCodeAt(0))) {
      throw this.createILLEGAL(char);
    } else {
      break;
    }
  }

  if (idx === start) {
    throw this.createILLEGAL(char);
  }

  return new _tokens.NumericToken({
    value: parseNumeric(stream, idx, 8, start)
  });
}

function readBinaryLiteral(stream) {
  let start,
      idx = start = 2;
  let char = stream.peek(idx);

  while (!terminates(char) && !(0, _readtable.isEOS)(char)) {
    if (char !== '0' && char !== '1') {
      break;
    }
    char = stream.peek(idx);
    idx++;
  }

  if (idx === start) {
    throw this.createILLEGAL(char);
  }

  if (!(0, _readtable.isEOS)(char) && !terminates(char) && (isIdentifierStart(char) || isDecimalChar(char))) {
    throw this.createILLEGAL(char);
  }

  return new _tokens.NumericToken({
    value: parseNumeric(stream, idx, 2, start)
  });
}

function readHexLiteral(stream) {
  let start,
      idx = start = 2,
      char = stream.peek(idx);
  while (!terminates(char)) {
    let hex = (0, _utils.getHexValue)(char);
    if (hex === -1) {
      break;
    }
    char = stream.peek(++idx);
  }

  if (idx === start) {
    throw this.createILLEGAL(char);
  }

  if (!(0, _readtable.isEOS)(char) && !terminates(char) && isIdentifierStart(char)) {
    throw this.createILLEGAL(char);
  }

  return new _tokens.NumericToken({
    value: parseNumeric(stream, idx, 16, start)
  });
}

function parseNumeric(stream, len, radix, start = 0) {
  stream.readString(start);
  return parseInt(stream.readString(len - start), radix);
}

function isDecimalChar(char) {
  return '0' <= char && char <= '9';
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9yZWFkZXIvcmVhZC1udW1lcmljLmpzIl0sIm5hbWVzIjpbInJlYWROdW1lcmljTGl0ZXJhbCIsImlzSWRlbnRpZmllclBhcnRFUzYiLCJpc0lkZW50aWZpZXJQYXJ0IiwiaXNJZGVudGlmaWVyU3RhcnRFUzYiLCJpc0lkZW50aWZpZXJTdGFydCIsInRlcm1pbmF0ZXMiLCJzdHJlYW0iLCJpZHgiLCJjaGFyIiwicGVlayIsInRvTG93ZXJDYXNlIiwicmVhZEhleExpdGVyYWwiLCJjYWxsIiwicmVhZEJpbmFyeUxpdGVyYWwiLCJyZWFkT2N0YWxMaXRlcmFsIiwiaXNEZWNpbWFsQ2hhciIsInJlYWRMZWdhY3lPY3RhbExpdGVyYWwiLCJ2YWx1ZSIsInJlYWRTdHJpbmciLCJhZGREZWNpbWFsTGl0ZXJhbFN1ZmZpeExlbmd0aCIsImNyZWF0ZUlMTEVHQUwiLCJpc09jdGFsIiwiY2hhckNvZGVBdCIsInBhcnNlTnVtZXJpYyIsIm9jdGFsIiwibm9jdGFsIiwic3RhcnQiLCJoZXgiLCJsZW4iLCJyYWRpeCIsInBhcnNlSW50Il0sIm1hcHBpbmdzIjoiOzs7OztrQkFnQndCQSxrQjs7QUFkeEI7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBSUEsTUFBTTtBQUNKQyx1QkFBcUJDLGdCQURqQjtBQUVKQyx3QkFBc0JDO0FBRmxCLGlCQUFOOztBQUtBLElBQUlDLFVBQUo7O0FBRWUsU0FBU0wsa0JBQVQsQ0FBNEJNLE1BQTVCLEVBQWdEO0FBQzdERCxlQUFhLDBCQUFjLHFDQUFkLENBQWI7QUFDQSxNQUFJRSxNQUFNLENBQVY7QUFBQSxNQUNFQyxPQUFPRixPQUFPRyxJQUFQLEVBRFQ7O0FBR0EsTUFBSUQsU0FBUyxHQUFiLEVBQWtCO0FBQ2hCQSxXQUFPRixPQUFPRyxJQUFQLENBQVksRUFBRUYsR0FBZCxDQUFQO0FBQ0EsUUFBSSxDQUFDLHNCQUFNQyxJQUFOLENBQUwsRUFBa0I7QUFDaEJBLGFBQU9BLEtBQUtFLFdBQUwsRUFBUDtBQUNBLGNBQVFGLElB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VCxDQUFzQmpCLE1BQXRCLEVBQThCc0IsR0FBOUIsRUFBbUNDLEtBQW5DLEVBQTBDSCxRQUFRLENBQWxELEVBQXFEO0FBQ25EcEIsU0FBT1ksVUFBUCxDQUFrQlEsS0FBbEI7QUFDQSxTQUFPSSxTQUFTeEIsT0FBT1ksVUFBUCxDQUFrQlUsTUFBTUYsS0FBeEIsQ0FBVCxFQUF5Q0csS0FBekMsQ0FBUDtBQUNEOztBQUVELFNBQVNkLGFBQVQsQ0FBdUJQLElBQXZCLEVBQTZCO0FBQzNCLFNBQU8sT0FBT0EsSUFBUCxJQUFlQSxRQUFRLEdBQTlCO0FBQ0QiLCJmaWxlIjoicmVhZC1udW1lcmljLmpzIiwic291cmNlc0NvbnRlbnQiOlsiLy8gQGZsb3dcblxuaW1wb3J0IHsgaXNFT1MsIGdldEN1cnJlbnRSZWFkdGFibGUgfSBmcm9tICdyZWFkdGFibGUnO1xuaW1wb3J0IHsgY29kZSB9IGZyb20gJ2VzdXRpbHMnO1xuaW1wb3J0IHsgaXNUZXJtaW5hdGluZywgZ2V0SGV4VmFsdWUgfSBmcm9tICcuL3V0aWxzJztcbmltcG9ydCB7IE51bWVyaWNUb2tlbiB9IGZyb20gJy4uL3Rva2Vucyc7XG5cbmltcG9ydCB0eXBlIHsgQ2hhclN0cmVhbSB9IGZyb20gJ3JlYWR0YWJsZSc7XG5cbmNvbnN0IHtcbiAgaXNJZGVudGlmaWVyUGFydEVTNjogaXNJZGVudGlmaWVyUGFydCxcbiAgaXNJZGVudGlmaWVyU3RhcnRFUzY6IGlzSWRlbnRpZmllclN0YXJ0LFxufSA9IGNvZGU7XG5cbmxldCB0ZXJtaW5hdGVzO1xuXG5leHBvcnQgZGVmYXVsdCBmdW5jdGlvbiByZWFkTnVtZXJpY0xpdGVyYWwoc3RyZWFtOiBDaGFyU3RyZWFtKSB7XG4gIHRlcm1pbmF0ZXMgPSBpc1Rlcm1pbmF0aW5nKGdldEN1cnJlbnRSZWFkdGFibGUoKSk7XG4gIGxldCBpZHggPSAwLFxuICAgIGNoYXIgPSBzdHJlYW0ucGVlaygpO1xuXG4gIGlmIChjaGFyID09PSAnMCcpIHtcbiAgICBjaGFyID0gc3RyZWFtLnBlZWsoKytpZHgpO1xuICAgIGlmICghaXNFT1MoY2hhcikpIHtcbiAgICAgIGNoYXIgPSBjaGFyLnRvTG93ZXJDYXNlKCk7XG4gICAgICBzd2l0Y2ggKGNoYXIpIHtcbiAgICAgICAgY2FzZSAneCc6XG4gICAgICAgICAgcmV0dXJuIHJlYWRIZXhMaXRlcmFsLmNhbGwodGhpcywgc3RyZWFtKTtcbiAgICAgICAgY2FzZSAnYic6XG4gICAgICAgICAgcmV0dXJuIHJlYWRCaW5hcnlMaXRlcmFsLmNhbGwodGhpcywgc3RyZWFtKTtcbiAgICAgICAgY2FzZSAnbyc6XG4gICAgICAgICAgcmV0dXJuIHJlYWRPY3RhbExpdGVyYWwuY2FsbCh0aGlzLCBzdHJlYW0pO1xuICAgICAgICBkZWZhdWx0OlxuICAgICAgICAgIGlmIChpc0RlY2ltYWxDaGFyKGNoYXIpKSB7XG4gICAgICAgICAgICByZXR1cm4gcmVhZExlZ2FjeU9jdGFsTGl0ZXJhbC5jYWxsKHRoaXMsIHN0cmVhbSk7IC8vIHJlYWRzIGxlZ2FjeSBvY3RhbCBhbmQgZGVjaW1hbFxuICAgICAgICAgIH1cbiAgICAgIH1cbiAgICB9IGVsc2Uge1xuICAgICAgcmV0dXJuIG5ldyBOdW1lcmljVG9rZW4oe1xuICAgICAgICB2YWx1ZTogK3N0cmVhbS5yZWFkU3RyaW5nKCksXG4gICAgICB9KTtcbiAgICB9XG4gIH0gZWxzZSBpZiAoY2hhciAhPT0gJy4nKSB7XG4gICAgd2hpbGUgKCF0ZXJtaW5hdGVzKGNoYXIpICYmIGlzRGVjaW1hbENoYXIoY2hhcikpIHtcbiAgICAgIGNoYXIgPSBzdHJlYW0ucGVlaygrK2lkeCk7XG4gICAgfVxuICAgIGlmIChpc0VPUyhjaGFyKSkge1xuICAgICAgcmV0dXJuIG5ldyBOdW1lcmljVG9rZW4oe1xuICAgICAgICB2YWx1ZTogK3N0cmVhbS5yZWFkU3RyaW5nKGlkeCksXG4gICAgICB9KTtcbiAgICB9XG4gIH1cblxuICBpZHggPSBhZGREZWNpbWFsTGl0ZXJhbFN1ZmZpeExlbmd0aC5jYWxsKHRoaXMsIHN0cmVhbSwgaWR4KTtcblxuICBjaGFyID0gc3RyZWFtLnBlZWsoaWR4KTtcbiAgaWYgKCFpc0VPUyhjaGFyKSAmJiAhdGVybWluYXRlcyhjaGFyKSAmJiBpc0lkZW50aWZpZXJTdGFydChjaGFyKSkge1xuICAgIHRocm93IHRoaXMuY3JlYXRlSUxMRUdBTChjaGFyKTtcbiAgfVxuXG4gIHJldHVybiBuZXcgTnVtZXJpY1Rva2VuKHtcbiAgICB2YWx1ZTogK3N0cmVhbS5yZWFkU3RyaW5nKGlkeCksXG4gIH0pO1xufVxuXG5mdW5jdGlvbiBhZGREZWNpbWFsTGl0ZXJhbFN1ZmZpeExlbmd0aChzdHJlYW0sIGlkeCkge1xuICBsZXQgY2hhciA9IHN0cmVhbS5wZWVrKGlkeCk7XG4gIGlmIChjaGFyID09PSAnLicpIHtcbiAgICBjaGFyID0gc3RyZWFtLnBlZWsoKytpZHgpO1xuICAgIGlmIChpc0VPUyhjaGFyKSkgcmV0dXJuIGlkeDtcblxuICAgIHdoaWxlIChpc0RlY2ltYWxDaGFyKGNoYXIpKSB7XG4gICAgICBjaGFyID0gc3RyZWFtLnBlZWsoKytpZHgpO1xuICAgICAgaWYgKHRlcm1pbmF0ZXMoY2hhcikgfHwgaXNFT1MoY2hhcikpIHJldHVybiBpZHg7XG4gICAgfVxuICB9XG5cbiAgaWYgKGNoYXIudG9Mb3dlckNhc2UoKSA9PT0gJ2UnKSB7XG4gICAgY2hhciA9IHN0cmVhbS5wZWVrKCsraWR4KTtcbiAgICBpZiAoaXNFT1MoY2hhcikpIHRocm93IHRoaXMuY3JlYXRlSUxMRUdBTChjaGFyKTtcblxuICAgIGlmIChjaGFyID09PSAnKycgfHwgY2hhciA9PT0gJy0nKSB7XG4gICAgICBjaGFyID0gc3RyZWFtLnBlZWsoKytpZHgpO1xuICAgICAgaWYgKGlzRU9TKGNoYXIpKSB0aHJvdyB0aGlzLmNyZWF0ZUlMTEVHQUwoY2hhcik7XG4gICAgfVxuXG4gICAgd2hpbGUgKGlzRGVjaW1hbENoYXIoY2hhcikpIHtcbiAgICAgIGNoYXIgPSBzdHJlYW0ucGVlaygrK2lkeCk7XG4gICAgICBpZiAodGVybWluYXRlcyhjaGFyKSB8fCBpc0VPUyhjaGFyKSkgYnJlYWs7XG4gICAgfVxuICB9XG4gIHJldHVybiBpZHg7XG59XG5cbmZ1bmN0aW9uIHJlYWRMZWdhY3lPY3RhbExpdGVyYWwoc3RyZWFtKSB7XG4gIGxldCBpZHggPSAwLFxuICAgIGlzT2N0YWwgPSB0cnVlLFxuICAgIGNoYXIgPSBzdHJlYW0ucGVlaygpO1xuXG4gIHdoaWxlICghdGVybWluYXRlcyhjaGFyKSAmJiAhaXNFT1MoY2hhcikpIHtcbiAgICBpZiAoJzAnIDw9IGNoYXIgJiYgY2hhciA8PSAnNycpIHtcbiAgICAgIGlkeCsrO1xuICAgIH0gZWxzZSBpZiAoY2hhciA9PT0gJzgnIHx8IGNoYXIgPT09ICc5Jykge1xuICAgICAgaXNPY3RhbCA9IGZhbHNlO1xuICAgICAgaWR4Kys7XG4gICAgfSBlbHNlIGlmIChpc0lkZW50aWZpZXJQYXJ0KGNoYXIuY2hhckNvZGVBdCgwKSkpIHtcbiAgICAgIHRocm93IHRoaXMuY3JlYXRlSUxMRUdBTChjaGFyKTtcbiAgICB9IGVsc2Uge1xuICAgICAgYnJlYWs7XG4gICAgfVxuXG4gICAgY2hhciA9IHN0cmVhbS5wZWVrKGlkeCk7XG4gIH1cblxuICBpZiAoIWlzT2N0YWwpXG4gICAgcmV0dXJuIG5ldyBOdW1lcmljVG9rZW4oe1xuICAgICAgdmFsdWU6IHBhcnNlTnVtZXJpYyhzdHJlYW0sIGlkeCwgMTApLFxuICAgICAgb2N0YWw6IHRydWUsXG4gICAgICBub2N0YWw6ICFpc09jdGFsLFxuICAgIH0pO1xuXG4gIHJldHVybiBuZXcgTnVtZXJpY1Rva2VuKHtcbiAgICB2YWx1ZTogcGFyc2VOdW1lcmljKHN0cmVhbSwgaWR4LCA4KSxcbiAgICBvY3RhbDogdHJ1ZSxcbiAgICBub2N0YWw6ICFpc09jdGFsLFxuICB9KTtcbn1cblxuZnVuY3Rpb24gcmVhZE9jdGFsTGl0ZXJhbChzdHJlYW0pIHtcbiAgbGV0IHN0YXJ0LFxuICAgIGlkeCA9IChzdGFydCA9IDIpLFxuICAgIGNoYXIgPSBzdHJlYW0ucGVlayhpZHgpO1xuICB3aGlsZSAoIXRlcm1pbmF0ZXMoY2hhcikgJiYgIWlzRU9TKGNoYXIpKSB7XG4gICAgaWYgKCcwJyA8PSBjaGFyICYmIGNoYXIgPD0gJzcnKSB7XG4gICAgICBjaGFyID0gc3RyZWFtLnBlZWsoKytpZHgpO1xuICAgIH0gZWxzZSBpZiAoaXNJZGVudGlmaWVyUGFydChjaGFyLmNoYXJDb2RlQXQoMCkpKSB7XG4gICAgICB0aHJvdyB0aGlzLmNyZWF0ZUlMTEVHQUwoY2hhcik7XG4gICAgfSBlbHNlIHtcbiAgICAgIGJyZWFrO1xuICAgIH1cbiAgfVxuXG4gIGlmIChpZHggPT09IHN0YXJ0KSB7XG4gICAgdGhyb3cgdGhpcy5jcmVhdGVJTExFR0FMKGNoYXIpO1xuICB9XG5cbiAgcmV0dXJuIG5ldyBOdW1lcmljVG9rZW4oe1xuICAgIHZhbHVlOiBwYXJzZU51bWVyaWMoc3RyZWFtLCBpZHgsIDgsIHN0YXJ0KSxcbiAgfSk7XG59XG5cbmZ1bmN0aW9uIHJlYWRCaW5hcnlMaXRlcmFsKHN0cmVhbSkge1xuICBsZXQgc3RhcnQsXG4gICAgaWR4ID0gKHN0YXJ0ID0gMik7XG4gIGxldCBjaGFyID0gc3RyZWFtLnBlZWsoaWR4KTtcblxuICB3aGlsZSAoIXRlcm1pbmF0ZXMoY2hhcikgJiYgIWlzRU9TKGNoYXIpKSB7XG4gICAgaWYgKGNoYXIgIT09ICcwJyAmJiBjaGFyICE9PSAnMScpIHtcbiAgICAgIGJyZWFrO1xuICAgIH1cbiAgICBjaGFyID0gc3RyZWFtLnBlZWsoaWR4KTtcbiAgICBpZHgrKztcbiAgfVxuXG4gIGlmIChpZHggPT09IHN0YXJ0KSB7XG4gICAgdGhyb3cgdGhpcy5jcmVhdGVJTExFR0FMKGNoYXIpO1xuICB9XG5cbiAgaWYgKFxuICAgICFpc0VPUyhjaGFyKSAmJlxuICAgICF0ZXJtaW5hdGVzKGNoYXIpICYmXG4gICAgKGlzSWRlbnRpZmllclN0YXJ0KGNoYXIpIHx8IGlzRGVjaW1hbENoYXIoY2hhcikpXG4gICkge1xuICAgIHRocm93IHRoaXMuY3JlYXRlSUxMRUdBTChjaGFyKTtcbiAgfVxuXG4gIHJldHVybiBuZXcgTnVtZXJpY1Rva2VuKHtcbiAgICB2YWx1ZTogcGFyc2VOdW1lcmljKHN0cmVhbSwgaWR4LCAyLCBzdGFydCksXG4gIH0pO1xufVxuXG5mdW5jdGlvbiByZWFkSGV4TGl0ZXJhbChzdHJlYW0pIHtcbiAgbGV0IHN0YXJ0LFxuICAgIGlkeCA9IChzdGFydCA9IDIpLFxuICAgIGNoYXIgPSBzdHJlYW0ucGVlayhpZHgpO1xuICB3aGlsZSAoIXRlcm1pbmF0ZXMoY2hhcikpIHtcbiAgICBsZXQgaGV4ID0gZ2V0SGV4VmFsdWUoY2hhcik7XG4gICAgaWYgKGhleCA9PT0gLTEpIHtcbiAgICAgIGJyZWFrO1xuICAgIH1cbiAgICBjaGFyID0gc3RyZWFtLnBlZWsoKytpZHgpO1xuICB9XG5cbiAgaWYgKGlkeCA9PT0gc3RhcnQpIHtcbiAgICB0aHJvdyB0aGlzLmNyZWF0ZUlMTEVHQUwoY2hhcik7XG4gIH1cblxuICBpZiAoIWlzRU9TKGNoYXIpICYmICF0ZXJtaW5hdGVzKGNoYXIpICYmIGlzSWRlbnRpZmllclN0YXJ0KGNoYXIpKSB7XG4gICAgdGhyb3cgdGhpcy5jcmVhdGVJTExFR0FMKGNoYXIpO1xuICB9XG5cbiAgcmV0dXJuIG5ldyBOdW1lcmljVG9rZW4oe1xuICAgIHZhbHVlOiBwYXJzZU51bWVyaWMoc3RyZWFtLCBpZHgsIDE2LCBzdGFydCksXG4gIH0pO1xufVxuXG5mdW5jdGlvbiBwYXJzZU51bWVyaWMoc3RyZWFtLCBsZW4sIHJhZGl4LCBzdGFydCA9IDApIHtcbiAgc3RyZWFtLnJlYWRTdHJpbmcoc3RhcnQpO1xuICByZXR1cm4gcGFyc2VJbnQoc3RyZWFtLnJlYWRTdHJpbmcobGVuIC0gc3RhcnQpLCByYWRpeCk7XG59XG5cbmZ1bmN0aW9uIGlzRGVjaW1hbENoYXIoY2hhcikge1xuICByZXR1cm4gJzAnIDw9IGNoYXIgJiYgY2hhciA8PSAnOSc7XG59XG4iXX0=