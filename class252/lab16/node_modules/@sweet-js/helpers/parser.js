'lang sweet.js';

import { Either, Left } from './either';
import { Maybe, Just, Nothing } from './maybe';

export class ImmutableContext {

  constructor(ctx) {
    this.ctx = ctx;
    this.mark = ctx.mark();
    let v = ctx.next();
    ctx.reset(this.mark);
    this.value = v.done ? new Nothing() : Maybe.of(v.value);
  }

  head() {
    return this.value;
  }

  rest() {
    this.ctx.reset(this.mark);
    this.ctx.next();
    return new ImmutableContext(this.ctx);
  }
}

export default class Parser {

  constructor(runner) {
    this._runner = runner;
  }

  run(ctx) {
    if (!(ctx instanceof ImmutableContext)) {
      ctx = new ImmutableContext(ctx);
    }
    return this._runner(ctx);
  }

  // $FlowFixMe: computed properties still not supported in flow
  static ['fantasy-land/of'](a) {
    return Parser.of(a);
  }

  static of(a) {
    return new Parser(ctx => Either.of([a, ctx]));
  }

  static failure(msg) {
    return new Parser(ctx => {
      return new Left(msg);
    });
  }

  // $FlowFixMe: computed properties still not supported in flow
  static ['fantasy-land/zero']() {
    return Parser.zero();
  }

  static zero() {
    return Parser.failure('');
  }

  static empty() {
    return new Parser(ctx => {
      let i = ctx.head();
      if (i instanceof Nothing) {
        return Either.of([void 0, ctx.rest()]);
      } else {
        return new Left('token stream is not empty');
      }
    });
  }

  static item() {
    return new Parser(ctx => {
      let i = ctx.head();
      if (i instanceof Just) {
        return Either.of([i.value, ctx.rest()]);
      } else {
        return new Left('no more tokens to consume');
      }
    });
  }

  static sat(f, msg = 'Did not satisfy predicate') {
    return Parser.item().chain(item => f(item) ? Parser.of(item) : Parser.failure(msg));
  }

  // $FlowFixMe: computed properties still not supported in flow
  ['fantasy-land/ap'](parser) {
    return this.ap(parser);
  }

  ap(parser) {
    return new Parser(ctx => {
      return this.run(ctx).chain(([a, ctx]) => parser.run(ctx).map(([f, ctx]) => [f(a), ctx]));
    });
  }

  // $FlowFixMe: computed properties still not supported in flow
  ['fantasy-land/map'](f) {
    return this.map(f);
  }

  map(f) {
    return new Parser(ctx => this.run(ctx).map(([aval, ctx]) => [f(aval), ctx]));
  }

  // $FlowFixMe: computed properties still not supported in flow
  ['fantasy-land/alt'](other) {
    return this.alt(other);
  }

  alt(other) {
    return new Parser(ctx => {
      let r = this.run(ctx);
      if (r instanceof Left) {
        return other.run(ctx);
      }
      return r;
    });
  }

  // $FlowFixMe: computed properties still not supported in flow
  ['fantasy-land/chain'](f) {
    return this.chain(f);
  }

  chain(f) {
    return new Parser(ctx => this.run(ctx).map(([v, ctx]) => [f(v), ctx]).chain(([parser, ctx]) => parser.run(ctx)));
  }
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInNyYy9wYXJzZXIuanMiXSwibmFtZXMiOlsiRWl0aGVyIiwiTGVmdCIsIk1heWJlIiwiSnVzdCIsIk5vdGhpbmciLCJJbW11dGFibGVDb250ZXh0IiwiY29uc3RydWN0b3IiLCJjdHgiLCJtYXJrIiwidiIsIm5leHQiLCJyZXNldCIsInZhbHVlIiwiZG9uZSIsIm9mIiwiaGVhZCIsInJlc3QiLCJQYXJzZXIiLCJydW5uZXIiLCJfcnVubmVyIiwicnVuIiwiYSIsImZhaWx1cmUiLCJtc2ciLCJ6ZXJvIiwiZW1wdHkiLCJpIiwiaXRlbSIsInNhdCIsImYiLCJjaGFpbiIsInBhcnNlciIsImFwIiwibWFwIiwiYXZhbCIsIm90aGVyIiwiYWx0IiwiciJdLCJtYXBwaW5ncyI6IkFBQUE7O0FBRUEsU0FBU0EsTUFBVCxFQUFpQkMsSUFBakIsUUFBNkIsVUFBN0I7QUFDQSxTQUFTQyxLQUFULEVBQWdCQyxJQUFoQixFQUFzQkMsT0FBdEIsUUFBcUMsU0FBckM7O0FBaUJBLE9BQU8sTUFBTUMsZ0JBQU4sQ0FBMEI7O0FBSy9CQyxjQUFZQyxHQUFaLEVBQTZCO0FBQzNCLFNBQUtBLEdBQUwsR0FBV0EsR0FBWDtBQUNBLFNBQUtDLElBQUwsR0FBWUQsSUFBSUMsSUFBSixFQUFaO0FBQ0EsUUFBSUMsSUFBSUYsSUFBSUcsSUFBSixFQUFSO0FBQ0FILFFBQUlJLEtBQUosQ0FBVSxLQUFLSCxJQUFmO0FBQ0EsU0FBS0ksS0FBTCxHQUFhSCxFQUFFSSxJQUFGLEdBQVMsSUFBSVQsT0FBSixFQUFULEdBQXlCRixNQUFNWSxFQUFOLENBQVNMLEVBQUVHLEtBQVgsQ0FBdEM7QUFDRDs7QUFFREcsU0FBaUI7QUFDZixXQUFPLEtBQUtILEtBQVo7QUFDRDs7QUFFREksU0FBNEI7QUFDMUIsU0FBS1QsR0FBTCxDQUFTSSxLQUFULENBQWUsS0FBS0gsSUFBcEI7QUFDQSxTQUFLRCxHQUFMLENBQVNHLElBQVQ7QUFDQSxXQUFPLElBQUlMLGdCQUFKLENBQXFCLEtBQUtFLEdBQTFCLENB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LENBQUMsQ0FBQ0MsTUFBRCxFQUFTeEIsR0FBVCxDQUFELEtBQW1Cd0IsT0FBT1gsR0FBUCxDQUFXYixHQUFYLENBRjVCLENBREssQ0FBUDtBQUtEO0FBaEgrQiIsImZpbGUiOiJwYXJzZXIuanMiLCJzb3VyY2VzQ29udGVudCI6WyInbGFuZyBzd2VldC5qcyc7XG4vLyBAZmxvd1xuaW1wb3J0IHsgRWl0aGVyLCBMZWZ0IH0gZnJvbSAnLi9laXRoZXInO1xuaW1wb3J0IHsgTWF5YmUsIEp1c3QsIE5vdGhpbmcgfSBmcm9tICcuL21heWJlJztcblxudHlwZSBNYXJrID0ge307XG5cbmludGVyZmFjZSBDb250ZXh0PFQ+IHtcbiAgbmV4dCgpOiB7XG4gICAgZG9uZTogYm9vbGVhbjtcbiAgICB2YWx1ZTogVFxuICB9O1xuXG4gIG1hcmsoKTogTWFyaztcblxuICBjb250ZXh0aWZ5KFQpOiBDb250ZXh0PFQ+O1xuXG4gIHJlc2V0KE1hcmspOiB2b2lkO1xufVxuXG5leHBvcnQgY2xhc3MgSW1tdXRhYmxlQ29udGV4dDxUPiB7XG4gIGN0eDogQ29udGV4dDxUPjtcbiAgdmFsdWU6IE1heWJlPFQ+O1xuICBtYXJrOiBNYXJrO1xuXG4gIGNvbnN0cnVjdG9yKGN0eDogQ29udGV4dDxUPikge1xuICAgIHRoaXMuY3R4ID0gY3R4O1xuICAgIHRoaXMubWFyayA9IGN0eC5tYXJrKCk7XG4gICAgbGV0IHYgPSBjdHgubmV4dCgpO1xuICAgIGN0eC5yZXNldCh0aGlzLm1hcmspO1xuICAgIHRoaXMudmFsdWUgPSB2LmRvbmUgPyBuZXcgTm90aGluZygpIDogTWF5YmUub2Yodi52YWx1ZSk7XG4gIH1cblxuICBoZWFkKCk6IE1heWJlPFQ+IHtcbiAgICByZXR1cm4gdGhpcy52YWx1ZTtcbiAgfVxuXG4gIHJlc3QoKTogSW1tdXRhYmxlQ29udGV4dDxUPiB7XG4gICAgdGhpcy5jdHgucmVzZXQodGhpcy5tYXJrKTtcbiAgICB0aGlzLmN0eC5uZXh0KCk7XG4gICAgcmV0dXJuIG5ldyBJbW11dGFibGVDb250ZXh0KHRoaXMuY3R4KTsgXG4gIH1cbn1cblxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgUGFyc2VyPEEsIEM+IHtcbiAgX3J1bm5lcjogSW1tdXRhYmxlQ29udGV4dDxDPiA9PiBFaXRoZXI8c3RyaW5nLCBbQSwgSW1tdXRhYmxlQ29udGV4dDxDPl0+O1xuXG4gIGNvbnN0cnVjdG9yKHJ1bm5lcjogSW1tdXRhYmxlQ29udGV4dDxDPiA9PiBFaXRoZXI8c3RyaW5nLCBbQSwgSW1tdXRhYmxlQ29udGV4dDxDPl0+KSB7XG4gICAgdGhpcy5fcnVubmVyID0gcnVubmVyO1xuICB9XG4gIFxuICBydW4oY3R4OiBJbW11dGFibGVDb250ZXh0PCo+IHwgQ29udGV4dDwqPik6IEVpdGhlcjxzdHJpbmcsIFtBLCBJbW11dGFibGVDb250ZXh0PCo+XT4ge1xuICAgIGlmICghKGN0eCBpbnN0YW5jZW9mIEltbXV0YWJsZUNvbnRleHQpKSB7XG4gICAgICBjdHggPSBuZXcgSW1tdXRhYmxlQ29udGV4dChjdHgpO1xuICAgIH1cbiAgICByZXR1cm4gdGhpcy5fcnVubmVyKGN0eCk7XG4gIH1cblxuICAvLyAkRmxvd0ZpeE1lOiBjb21wdXRlZCBwcm9wZXJ0aWVzIHN0aWxsIG5vdCBzdXBwb3J0ZWQgaW4gZmxvd1xuICBzdGF0aWMgWydmYW50YXN5LWxhbmQvb2YnXShhOiBBKTogUGFyc2VyPEEsICo+IHtcbiAgICByZXR1cm4gUGFyc2VyLm9mKGEpO1xuICB9XG5cbiAgc3RhdGljIG9mKGE6IEEpOiBQYXJzZXI8QSwgKj4ge1xuICAgIHJldHVybiBuZXcgUGFyc2VyKGN0eCA9PiBFaXRoZXIub2YoW2EsIGN0eF0pKTtcbiAgfVxuXG4gIHN0YXRpYyBmYWlsdXJlKG1zZzogc3RyaW5nKTogUGFyc2VyPCosICo+IHtcbiAgICByZXR1cm4gbmV3IFBhcnNlcihjdHggPT4geyByZXR1cm4gbmV3IExlZnQobXNnKTsgfSk7XG4gIH1cblxuICAvLyAkRmxvd0ZpeE1lOiBjb21wdXRlZCBwcm9wZXJ0aWVzIHN0aWxsIG5vdCBzdXBwb3J0ZWQgaW4gZmxvd1xuICBzdGF0aWMgWydmYW50YXN5LWxhbmQvemVybyddKCk6IFBhcnNlcjwqLCAqPiB7XG4gICAgcmV0dXJuIFBhcnNlci56ZXJvKCk7XG4gIH1cblxuICBzdGF0aWMgemVybygpOiBQYXJzZXI8KiwgKj4ge1xuICAgIHJldHVybiBQYXJzZXIuZmFpbHVyZSgnJyk7XG4gIH1cblxuICBzdGF0aWMgZW1wdHkoKTogUGFyc2VyPHZvaWQsICo+IHtcbiAgICByZXR1cm4gbmV3IFBhcnNlcihjdHggPT4ge1xuICAgICAgbGV0IGkgPSBjdHguaGVhZCgpO1xuICAgICAgaWYgKGkgaW5zdGFuY2VvZiBOb3RoaW5nKSB7XG4gICAgICAgIHJldHVybiBFaXRoZXIub2YoW3ZvaWQgMCwgY3R4LnJlc3QoKV0pO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgcmV0dXJuIG5ldyBMZWZ0KCd0b2tlbiBzdHJlYW0gaXMgbm90IGVtcHR5Jyk7XG4gICAgICB9XG4gICAgfSk7XG4gIH1cblxuICBzdGF0aWMgaXRlbSgpOiBQYXJzZXI8KiwgKj4ge1xuICAgIHJldHVybiBuZXcgUGFyc2VyKGN0eCA9PiB7XG4gICAgICBsZXQgaSA9IGN0eC5oZWFkKCk7XG4gICAgICBpZiAoaSBpbnN0YW5jZW9mIEp1c3QpIHtcbiAgICAgICAgcmV0dXJuIEVpdGhlci5vZihbaS52YWx1ZSwgY3R4LnJlc3QoKV0pO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgcmV0dXJuIG5ldyBMZWZ0KCdubyBtb3JlIHRva2VucyB0byBjb25zdW1lJyk7XG4gICAgICB9XG4gICAgfSk7XG4gIH1cblxuICBzdGF0aWMgc2F0PFQ+KGY6IFQgPT4gYm9vbGVhbiwgbXNnOiBzdHJpbmcgPSAnRGlkIG5vdCBzYXRpc2Z5IHByZWRpY2F0ZScpOiBQYXJzZXI8VCwgVD4ge1xuICAgIHJldHVybiBQYXJzZXJcbiAgICAgIC5pdGVtKClcbiAgICAgIC5jaGFpbihpdGVtID0+IGYoaXRlbSkgPyBQYXJzZXIub2YoaXRlbSkgOiBQYXJzZXIuZmFpbHVyZShtc2cpKTtcbiAgfVxuXG4gIC8vICRGbG93Rml4TWU6IGNvbXB1dGVkIHByb3BlcnRpZXMgc3RpbGwgbm90IHN1cHBvcnRlZCBpbiBmbG93XG4gIFsnZmFudGFzeS1sYW5kL2FwJ108Qj4ocGFyc2VyOiBQYXJzZXI8QSA9PiBCLCBDPik6IFBhcnNlcjxCLCBDPiB7XG4gICAgcmV0dXJuIHRoaXMuYXAocGFyc2VyKTtcbiAgfVxuXG4gIGFwPEI+KHBhcnNlcjogUGFyc2VyPEEgPT4gQiwgQz4pOiBQYXJzZXI8QiwgQz4ge1xuICAgIHJldHVybiBuZXcgUGFyc2VyKGN0eCA9PiB7XG4gICAgICByZXR1cm4gdGhpcy5ydW4oY3R4KVxuICAgICAgICAuY2hhaW4oKFthLCBjdHhdKSA9PiBwYXJzZXIucnVuKGN0eCkubWFwKChbZiwgY3R4XSkgPT4gW2YoYSksIGN0eF0pKTtcbiAgICB9KTtcbiAgfVxuXG4gIC8vICRGbG93Rml4TWU6IGNvbXB1dGVkIHByb3BlcnRpZXMgc3RpbGwgbm90IHN1cHBvcnRlZCBpbiBmbG93XG4gIFsnZmFudGFzeS1sYW5kL21hcCddKGY6IEEgPT4gQik6IFBhcnNlcjxCLCBDPiB7XG4gICAgcmV0dXJuIHRoaXMubWFwKGYpO1xuICB9XG5cbiAgbWFwPEI+KGY6IEEgPT4gQik6IFBhcnNlcjxCLCBDPiB7XG4gICAgcmV0dXJuIG5ldyBQYXJzZXIoY3R4ID0+IHRoaXMucnVuKGN0eCkubWFwKChbYXZhbCwgY3R4XSkgPT4gW2YoYXZhbCksIGN0eF0pKTtcbiAgfVxuXG4gIC8vICRGbG93Rml4TWU6IGNvbXB1dGVkIHByb3BlcnRpZXMgc3RpbGwgbm90IHN1cHBvcnRlZCBpbiBmbG93XG4gIFsnZmFudGFzeS1sYW5kL2FsdCddKG90aGVyOiBQYXJzZXI8QSwgQz4pOiBQYXJzZXI8QSwgQz4ge1xuICAgIHJldHVybiB0aGlzLmFsdChvdGhlcik7XG4gIH1cblxuICBhbHQob3RoZXI6IFBhcnNlcjxBLCBDPik6IFBhcnNlcjxBLCBDPiB7XG4gICAgcmV0dXJuIG5ldyBQYXJzZXIoY3R4ID0+IHtcbiAgICAgIGxldCByID0gdGhpcy5ydW4oY3R4KTtcbiAgICAgIGlmIChyIGluc3RhbmNlb2YgTGVmdCkge1xuICAgICAgICByZXR1cm4gb3RoZXIucnVuKGN0eCk7XG4gICAgICB9XG4gICAgICByZXR1cm4gcjtcbiAgICB9KTtcbiAgfVxuXG5cbiAgLy8gJEZsb3dGaXhNZTogY29tcHV0ZWQgcHJvcGVydGllcyBzdGlsbCBub3Qgc3VwcG9ydGVkIGluIGZsb3dcbiAgWydmYW50YXN5LWxhbmQvY2hhaW4nXTxCPihmOiBBID0+IFBhcnNlcjxCLCAqPik6IFBhcnNlcjxCLCAqPiB7XG4gICAgcmV0dXJuIHRoaXMuY2hhaW4oZik7XG4gIH1cblxuICBjaGFpbjxCPihmOiBBID0+IFBhcnNlcjxCLCAqPik6IFBhcnNlcjxCLCAqPiB7XG4gICAgcmV0dXJuIG5ldyBQYXJzZXIoY3R4ID0+IFxuICAgICAgdGhpcy5ydW4oY3R4KVxuICAgICAgICAubWFwKChbdiwgY3R4XSkgPT4gW2YodiksIGN0eF0pXG4gICAgICAgIC5jaGFpbigoW3BhcnNlciwgY3R4XSkgPT4gcGFyc2VyLnJ1bihjdHgpKVxuICAgICk7XG4gIH1cbn1cblxuIl19