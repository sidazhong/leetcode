'lang sweet.js';

import Parser from './parser';
import { ImmutableContext } from './parser';
import * as H from './helpers';

import { Either, Left, Right } from './either';
import { Maybe, Just, Nothing } from './maybe';

function unsafeProp(prop, obj) {
  return obj[prop];
}

export const identifier = Parser.sat(H.isIdentifier, 'identifier');
export const identifierWith = pred => Parser.sat(obj => H.isIdentifier(obj) && pred(unsafeProp('value', H.unwrap(obj))), 'identifier');
export const keyword = Parser.sat(H.isKeyword, 'keyword');
export const keywordWith = pred => Parser.sat(obj => H.isKeyword(obj) && pred(unsafeProp('value', H.unwrap(obj))), 'keyword');
export const punctuator = Parser.sat(H.isPunctuator, 'punctuator');
export const punctuatorWith = pred => Parser.sat(obj => H.isPunctuator(obj) && pred(unsafeProp('value', H.unwrap(obj))), 'punctuator');
export const numeric = Parser.sat(H.isNumericLiteral, 'numeric');
export const numericWith = pred => Parser.sat(obj => H.isNumericLiteral(obj) && pred(unsafeProp('value', H.unwrap(obj))), 'numeric');
export const string = Parser.sat(H.isStringLiteral, 'string');
export const stringWith = pred => Parser.sat(obj => H.isStringLiteral(obj) && pred(unsafeProp('value', H.unwrap(obj))), 'string');
export const templateElement = Parser.sat(H.isTemplateElement, 'templateElement');
export const templateElementWith = pred => Parser.sat(obj => H.isTemplateElement(obj) && pred(unsafeProp('value', H.unwrap(obj))), 'templateElement');
export const template = Parser.sat(H.isTemplate, 'template');
export const templateWith = pred => Parser.sat(obj => H.isTemplate(obj) && pred(unsafeProp('value', H.unwrap(obj))), 'template');
export const regex = Parser.sat(H.isRegExp, 'regex');
export const regexWith = pred => Parser.sat(obj => H.isRegExp(obj) && pred(unsafeProp('value', H.unwrap(obj))), 'regex');
export const braces = Parser.sat(H.isBraces, 'braces');
export const brackets = Parser.sat(H.isBrackets, 'brackets');
export const parens = Parser.sat(H.isParens, 'parens');

function runParserInner(p, pred) {
  return new Parser(ctx => {
    let i = ctx.head();
    let originalCtx = ctx.ctx;
    if (i instanceof Just && pred(i.value)) {
      let innerCtx = originalCtx.contextify(i.value);
      let result = p.run(new ImmutableContext(innerCtx));
      if (result instanceof Right) {
        return Either.of([result.right[0], ctx.rest()]);
      }
      return result;
    } else {
      return new Left('');
    }
  });
}

export function delimiterInner(p) {
  return runParserInner(p, H.isDelimiter);
}

export function bracesInner(p) {
  return runParserInner(p, H.isBraces);
}

export function bracketsInner(p) {
  return runParserInner(p, H.isBrackets);
}

export function parensInner(p) {
  return runParserInner(p, H.isParens);
}

export function many(p) {
  return p.chain(x => many(p).chain(xs => Parser.of(xs.concat(x)))).alt(Parser.of([]));
}

export function many1(p) {
  return p.chain(x => many(p).chain(xs => Parser.of(xs.concat(x))));
}

export function sepBy1(p, sep) {
  return p.chain(x => many1(sep.chain(() => p.chain(y => Parser.of(y)))).chain(xs => Parser.of(xs.concat(x))));
}

export function sepBy(p, sep) {
  return sepBy1(p, sep).alt(Parser.of([]));
}

export function lift2(f) {
  return (a, b) => a.chain(va => b.chain(vb => Parser.of(f(va, vb))));
}

export function sequence(...parsers) {
  let init = Parser.of([]);
  let f = lift2((a, b) => a.concat(b));
  return parsers.reduce(f, init);
}

export function disj(a, b, msg = 'failed disjunction') {
  return a.alt(b).alt(Parser.failure(msg));
}

export function infixl(p, op) {
  function rest(x) {
    return op.chain(f => p.chain(y => rest(f(x, y)))).alt(Parser.of(x));
  }
  return p.chain(rest);
}

export function infixr(p, op) {
  return p.chain(x => op.chain(f => infixr(p, op).chain(y => Parser.of(f(x, y)))).alt(Parser.of(x)));
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInNyYy9jb21iaW5hdG9ycy5qcyJdLCJuYW1lcyI6WyJQYXJzZXIiLCJJbW11dGFibGVDb250ZXh0IiwiSCIsIkVpdGhlciIsIkxlZnQiLCJSaWdodCIsIk1heWJlIiwiSnVzdCIsIk5vdGhpbmciLCJ1bnNhZmVQcm9wIiwicHJvcCIsIm9iaiIsImlkZW50aWZpZXIiLCJzYXQiLCJpc0lkZW50aWZpZXIiLCJpZGVudGlmaWVyV2l0aCIsInByZWQiLCJ1bndyYXAiLCJrZXl3b3JkIiwiaXNLZXl3b3JkIiwia2V5d29yZFdpdGgiLCJwdW5jdHVhdG9yIiwiaXNQdW5jdHVhdG9yIiwicHVuY3R1YXRvcldpdGgiLCJudW1lcmljIiwiaXNOdW1lcmljTGl0ZXJhbCIsIm51bWVyaWNXaXRoIiwic3RyaW5nIiwiaXNTdHJpbmdMaXRlcmFsIiwic3RyaW5nV2l0aCIsInRlbXBsYXRlRWxlbWVudCIsImlzVGVtcGxhdGVFbGVtZW50IiwidGVtcGxhdGVFbGVtZW50V2l0aCIsInRlbXBsYXRlIiwiaXNUZW1wbGF0ZSIsInRlbXBsYXRlV2l0aCIsInJlZ2V4IiwiaXNSZWdFeHAiLCJyZWdleFdpdGgiLCJicmFjZXMiLCJpc0JyYWNlcyIsImJyYWNrZXRzIiwiaXNCcmFja2V0cyIsInBhcmVucyIsImlzUGFyZW5zIiwicnVuUGFyc2VySW5uZXIiLCJwIiwiY3R4IiwiaSIsImhlYWQiLCJvcmlnaW5hbEN0eCIsInZhbHVlIiwiaW5uZXJDdHgiLCJjb250ZXh0aWZ5IiwicmVzdWx0IiwicnVuIiwib2YiLCJyaWdodCIsInJlc3QiLCJkZWxpbWl0ZXJJbm5lciIsImlzRGVsaW1pdGVyIiwiYnJhY2VzSW5uZXIiLCJicmFja2V0c0lubmVyIiwicGFyZW5zSW5uZXIiLCJtYW55IiwiY2hhaW4iLCJ4IiwieHMiLCJjb25jYXQiLCJhbHQiLCJtYW55MSIsInNlcEJ5MSIsInNlcCIsInkiLCJzZXBCeSIsImxpZnQyIiwiZiIsImEiLCJiIiwidmEiLCJ2YiIsInNlcXVlbmNlIiwicGFyc2VycyIsImluaXQiLCJyZWR1Y2UiLCJkaXNqIiwibXNnIiwiZmFpbHVyZSIsImluZml4bCIsIm9wIiwiaW5maXhyIl0sIm1hcHBpbmdzIjoiQUFBQTs7QUFFQSxPQUFPQSxNQUFQLE1BQW1CLFVBQW5CO0FBQ0EsU0FBU0MsZ0JBQVQsUUFBaUMsVUFBakM7QUFDQSxPQUFPLEtBQUtDLENBQVosTUFBbUIsV0FBbkI7O0FBRUEsU0FBU0MsTUFBVCxFQUFpQkMsSUFBakIsRUFBdUJDLEtBQXZCLFFBQW9DLFVBQXBDO0FBQ0EsU0FBU0MsS0FBVCxFQUFnQkMsSUFBaEIsRUFBc0JDLE9BQXRCLFFBQXFDLFNBQXJDOztBQUVBLFNBQVNDLFVBQVQsQ0FBb0JDLElBQXBCLEVBQWtDQyxHQUFsQyxFQUFpRDtBQUMvQyxTQUFPQSxJQUFJRCxJQUFKLENBQVA7QUFDRDs7QUFFRCxPQUFPLE1BQU1FLGFBQWFaLE9BQU9hLEdBQVAsQ0FBV1gsRUFBRVksWUFBYixFQUEyQixZQUEzQixDQUFuQjtBQUNQLE9BQU8sTUFBTUMsaUJBQWtCQyxJQUFELElBQTZCaEIsT0FBT2EsR0FBUCxDQUFXRixPQUFPVCxFQUFFWSxZQUFGLENBQWVILEdBQWYsS0FBdUJLLEtBQUtQLFdBQVcsT0FBWCxFQUFvQlAsRUFBRWUsTUFBRixDQUFTTixHQUFULENBQXBCLENBQUwsQ0FBekMsRUFBbUYsWUFBbkYsQ0FBcEQ7QUFDUCxPQUFPLE1BQU1PLFVBQVVsQixPQUFPYSxHQUFQLENBQVdYLEVBQUVpQixTQUFiLEVBQXdCLFNBQXhCLENBQWhCO0FBQ1AsT0FBTyxNQUFNQyxjQUFlSixJQUFELElBQTZCaEIsT0FBT2EsR0FBUCxDQUFXRixPQUFPVCxFQUFFaUIsU0FBRixDQUFZUixHQUFaLEtBQW9CSyxLQUFLUCxXQUFXLE9BQVgsRUFBb0JQLEVBQUVlLE1BQUYsQ0FBU04sR0FBVCxDQUFwQixDQUFMLENBQXRDLEVBQWdGLFNBQWhGLENBQWpEO0FBQ1AsT0FBTyxNQUFNVSxhQUFhckIsT0FBT2EsR0FBUCxDQUFXWCxFQUFFb0IsWUFBYixFQUEy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ekIsQ0FBZCxFQUE0REosR0FBNUQsQ0FBZ0VyRSxPQUFPd0QsRUFBUCxDQUFVVSxDQUFWLENBQWhFLENBQWIsQ0FBUDtBQUNEIiwiZmlsZSI6ImNvbWJpbmF0b3JzLmpzIiwic291cmNlc0NvbnRlbnQiOlsiJ2xhbmcgc3dlZXQuanMnO1xuLy8gQGZsb3dcbmltcG9ydCBQYXJzZXIgZnJvbSAnLi9wYXJzZXInO1xuaW1wb3J0IHsgSW1tdXRhYmxlQ29udGV4dCB9IGZyb20gJy4vcGFyc2VyJztcbmltcG9ydCAqIGFzIEggZnJvbSAnLi9oZWxwZXJzJztcbmltcG9ydCB0eXBlIHsgVGVybSB9IGZyb20gJy4vaGVscGVycyc7XG5pbXBvcnQgeyBFaXRoZXIsIExlZnQsIFJpZ2h0IH0gZnJvbSAnLi9laXRoZXInO1xuaW1wb3J0IHsgTWF5YmUsIEp1c3QsIE5vdGhpbmcgfSBmcm9tICcuL21heWJlJztcblxuZnVuY3Rpb24gdW5zYWZlUHJvcChwcm9wOiBzdHJpbmcsIG9iajogYW55KTogYW55IHtcbiAgcmV0dXJuIG9ialtwcm9wXTtcbn1cblxuZXhwb3J0IGNvbnN0IGlkZW50aWZpZXIgPSBQYXJzZXIuc2F0KEguaXNJZGVudGlmaWVyLCAnaWRlbnRpZmllcicpO1xuZXhwb3J0IGNvbnN0IGlkZW50aWZpZXJXaXRoID0gKHByZWQ6IHN0cmluZyA9PiBib29sZWFuKSA9PiBQYXJzZXIuc2F0KG9iaiA9PiBILmlzSWRlbnRpZmllcihvYmopICYmIHByZWQodW5zYWZlUHJvcCgndmFsdWUnLCBILnVud3JhcChvYmopKSksICdpZGVudGlmaWVyJyk7XG5leHBvcnQgY29uc3Qga2V5d29yZCA9IFBhcnNlci5zYXQoSC5pc0tleXdvcmQsICdrZXl3b3JkJyk7XG5leHBvcnQgY29uc3Qga2V5d29yZFdpdGggPSAocHJlZDogc3RyaW5nID0+IGJvb2xlYW4pID0+IFBhcnNlci5zYXQob2JqID0+IEguaXNLZXl3b3JkKG9iaikgJiYgcHJlZCh1bnNhZmVQcm9wKCd2YWx1ZScsIEgudW53cmFwKG9iaikpKSwgJ2tleXdvcmQnKTtcbmV4cG9ydCBjb25zdCBwdW5jdHVhdG9yID0gUGFyc2VyLnNhdChILmlzUHVuY3R1YXRvciwgJ3B1bmN0dWF0b3InKTtcbmV4cG9ydCBjb25zdCBwdW5jdHVhdG9yV2l0aCA9IChwcmVkOiBzdHJpbmcgPT4gYm9vbGVhbikgPT4gUGFyc2VyLnNhdChvYmogPT4gSC5pc1B1bmN0dWF0b3Iob2JqKSAmJiBwcmVkKHVuc2FmZVByb3AoJ3ZhbHVlJywgSC51bndyYXAob2JqKSkpLCAncHVuY3R1YXRvcicpO1xuZXhwb3J0IGNvbnN0IG51bWVyaWMgPSBQYXJzZXIuc2F0KEguaXNOdW1lcmljTGl0ZXJhbCwgJ251bWVyaWMnKTtcbmV4cG9ydCBjb25zdCBudW1lcmljV2l0aCA9IChwcmVkOiBudW1iZXIgPT4gYm9vbGVhbikgPT4gUGFyc2VyLnNhdChvYmogPT4gSC5pc051bWVyaWNMaXRlcmFsKG9iaikgJiYgcHJlZCh1bnNhZmVQcm9wKCd2YWx1ZScsIEgudW53cmFwKG9iaikpKSwgJ251bWVyaWMnKTtcbmV4cG9ydCBjb25zdCBzdHJpbmcgPSBQYXJzZXIuc2F0KEguaXNTdHJpbmdMaXRlcmFsLCAnc3RyaW5nJyk7XG5leHBvcnQgY29uc3Qgc3RyaW5nV2l0aCA9IChwcmVkOiBzdHJpbmcgPT4gYm9vbGVhbikgPT4gUGFyc2VyLnNhdChvYmogPT4gSC5pc1N0cmluZ0xpdGVyYWwob2JqKSAmJiBwcmVkKHVuc2FmZVByb3AoJ3ZhbHVlJywgSC51bndyYXAob2JqKSkpLCAnc3RyaW5nJyk7XG5leHBvcnQgY29uc3QgdGVtcGxhdGVFbGVtZW50ID0gUGFyc2VyLnNhdChILmlzVGVtcGxhdGVFbGVtZW50LCAndGVtcGxhdGVFbGVtZW50Jyk7XG5leHBvcnQgY29uc3QgdGVtcGxhdGVFbGVtZW50V2l0aCA9IChwcmVkOiBUZXJtID0+IGJvb2xlYW4pID0+IFBhcnNlci5zYXQob2JqID0+IEguaXNUZW1wbGF0ZUVsZW1lbnQob2JqKSAmJiBwcmVkKHVuc2FmZVByb3AoJ3ZhbHVlJywgSC51bndyYXAob2JqKSkpLCAndGVtcGxhdGVFbGVtZW50Jyk7XG5leHBvcnQgY29uc3QgdGVtcGxhdGUgPSBQYXJzZXIuc2F0KEguaXNUZW1wbGF0ZSwgJ3RlbXBsYXRlJyk7XG5leHBvcnQgY29uc3QgdGVtcGxhdGVXaXRoID0gKHByZWQ6IFRlcm0gPT4gYm9vbGVhbikgPT4gUGFyc2VyLnNhdChvYmogPT4gSC5pc1RlbXBsYXRlKG9iaikgJiYgcHJlZCh1bnNhZmVQcm9wKCd2YWx1ZScsIEgudW53cmFwKG9iaikpKSwgJ3RlbXBsYXRlJyk7XG5leHBvcnQgY29uc3QgcmVnZXggPSBQYXJzZXIuc2F0KEguaXNSZWdFeHAsICdyZWdleCcpO1xuZXhwb3J0IGNvbnN0IHJlZ2V4V2l0aCA9IChwcmVkOiBUZXJtID0+IGJvb2xlYW4pID0+IFBhcnNlci5zYXQob2JqID0+IEguaXNSZWdFeHAob2JqKSAmJiBwcmVkKHVuc2FmZVByb3AoJ3ZhbHVlJywgSC51bndyYXAob2JqKSkpLCAncmVnZXgnKTtcbmV4cG9ydCBjb25zdCBicmFjZXMgPSBQYXJzZXIuc2F0KEguaXNCcmFjZXMsICdicmFjZXMnKTtcbmV4cG9ydCBjb25zdCBicmFja2V0cyA9IFBhcnNlci5zYXQoSC5pc0JyYWNrZXRzLCAnYnJhY2tldHMnKTtcbmV4cG9ydCBjb25zdCBwYXJlbnMgPSBQYXJzZXIuc2F0KEguaXNQYXJlbnMsICdwYXJlbnMnKTtcblxuZnVuY3Rpb24gcnVuUGFyc2VySW5uZXIocDogUGFyc2VyPCosIFRlcm0+LCBwcmVkOiBUZXJtID0+IGJvb2xlYW4pOiBQYXJzZXI8KiwgVGVybT4ge1xuICByZXR1cm4gbmV3IFBhcnNlcihjdHggPT4ge1xuICAgIGxldCBpID0gY3R4LmhlYWQoKTtcbiAgICBsZXQgb3JpZ2luYWxDdHggPSBjdHguY3R4O1xuICAgIGlmIChpIGluc3RhbmNlb2YgSnVzdCAmJiBwcmVkKGkudmFsdWUpKSB7XG4gICAgICBsZXQgaW5uZXJDdHggPSBvcmlnaW5hbEN0eC5jb250ZXh0aWZ5KGkudmFsdWUpO1xuICAgICAgbGV0IHJlc3VsdCA9IHAucnVuKG5ldyBJbW11dGFibGVDb250ZXh0KGlubmVyQ3R4KSk7XG4gICAgICBpZiAocmVzdWx0IGluc3RhbmNlb2YgUmlnaHQpIHtcbiAgICAgICAgcmV0dXJuIEVpdGhlci5vZihbcmVzdWx0LnJpZ2h0WzBdLCBjdHgucmVzdCgpXSk7XG4gICAgICB9XG4gICAgICByZXR1cm4gcmVzdWx0O1xuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4gbmV3IExlZnQoJycpO1xuICAgIH1cbiAgfSk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBkZWxpbWl0ZXJJbm5lcihwOiBQYXJzZXI8KiwgVGVybT4pIHtcbiAgcmV0dXJuIHJ1blBhcnNlcklubmVyKHAsIEguaXNEZWxpbWl0ZXIpO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gYnJhY2VzSW5uZXIocDogUGFyc2VyPCosIFRlcm0+KSB7XG4gIHJldHVybiBydW5QYXJzZXJJbm5lcihwLCBILmlzQnJhY2VzKTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGJyYWNrZXRzSW5uZXIocDogUGFyc2VyPCosIFRlcm0+KSB7XG4gIHJldHVybiBydW5QYXJzZXJJbm5lcihwLCBILmlzQnJhY2tldHMpO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gcGFyZW5zSW5uZXIocDogUGFyc2VyPCosIFRlcm0+KSB7XG4gIHJldHVybiBydW5QYXJzZXJJbm5lcihwLCBILmlzUGFyZW5zKTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIG1hbnk8QT4ocDogUGFyc2VyPEEsICo+KTogUGFyc2VyPEFbXSwgKj4ge1xuICByZXR1cm4gcC5jaGFpbih4ID0+IG1hbnkocCkuY2hhaW4oeHMgPT4gUGFyc2VyLm9mKHhzLmNvbmNhdCh4KSkpKS5hbHQoUGFyc2VyLm9mKFtdKSk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBtYW55MTxBPihwOiBQYXJzZXI8QSwgKj4pOiBQYXJzZXI8QVtdLCAqPiB7XG4gIHJldHVybiBwLmNoYWluKHggPT4gbWFueShwKS5jaGFpbih4cyA9PiBQYXJzZXIub2YoeHMuY29uY2F0KHgpKSkpO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gc2VwQnkxPEEsIEI+KHA6IFBhcnNlcjxBLCAqPiwgc2VwOiBQYXJzZXI8QiwgKj4pOiBQYXJzZXI8QVtdLCAqPiB7XG4gIHJldHVybiBwLmNoYWluKHggPT4gXG4gICAgbWFueTEoc2VwLmNoYWluKCgpID0+IHAuY2hhaW4oeSA9PiBQYXJzZXIub2YoeSkpKSlcbiAgICAgIC5jaGFpbih4cyA9PiBQYXJzZXIub2YoeHMuY29uY2F0KHgpKSlcbiAgKTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHNlcEJ5PEEsIEI+KHA6IFBhcnNlcjxBLCAqPiwgc2VwOiBQYXJzZXI8QiwgKj4pOiBQYXJzZXI8QVtdLCAqPiB7XG4gIHJldHVybiBzZXBCeTEocCwgc2VwKS5hbHQoUGFyc2VyLm9mKFtdKSk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBsaWZ0MjxBLCBCLCBDPihmOiAoQSwgQikgPT4gQyk6IChhOiBQYXJzZXI8QSwgKj4sIGI6IFBhcnNlcjxCLCAqPikgPT4gUGFyc2VyPEMsICo+IHtcbiAgcmV0dXJuIChhLCBiKSA9PiBhLmNoYWluKHZhID0+IGIuY2hhaW4odmIgPT4gUGFyc2VyLm9mKGYodmEsIHZiKSkpKTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHNlcXVlbmNlPEE+KC4uLnBhcnNlcnM6IFBhcnNlcjxBLCAqPltdKTogUGFyc2VyPEFbXSwgKj4ge1xuICBsZXQgaW5pdDogUGFyc2VyPEFbXSwgKj4gPSBQYXJzZXIub2YoW10pO1xuICBsZXQgZjogKFBhcnNlcjxBW10sICo+LCBQYXJzZXI8QSwgKj4pID0+IFBhcnNlcjxBW10sICo+ID0gbGlmdDIoKGEsIGIpID0+IGEuY29uY2F0KGIpKTtcbiAgcmV0dXJuIHBhcnNlcnMucmVkdWNlKGYsIGluaXQpO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gZGlzajxBPihhOiBQYXJzZXI8QSwgKj4sIGI6IFBhcnNlcjxBLCAqPiwgbXNnOiBzdHJpbmcgPSAnZmFpbGVkIGRpc2p1bmN0aW9uJyk6IFBhcnNlcjxBLCAqPiB7XG4gIHJldHVybiBhLmFsdChiKS5hbHQoUGFyc2VyLmZhaWx1cmUobXNnKSk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBpbmZpeGw8QT4ocDogUGFyc2VyPEEsICo+LCBvcDogUGFyc2VyPChBLCBBKSA9PiBBLCAqPik6IFBhcnNlcjxBLCAqPiB7XG4gIGZ1bmN0aW9uIHJlc3QoeCkge1xuICAgIHJldHVybiBvcC5jaGFpbihmID0+IHAuY2hhaW4oeSA9PiByZXN0KGYoeCwgeSkpKSkuYWx0KFBhcnNlci5vZih4KSk7XG4gIH1cbiAgcmV0dXJuIHAuY2hhaW4ocmVzdCk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBpbmZpeHI8QT4ocDogUGFyc2VyPEEsICo+LCBvcDogUGFyc2VyPChBLCBBKSA9PiBBLCAqPik6IFBhcnNlcjxBLCAqPiB7XG4gIHJldHVybiBwLmNoYWluKHggPT4gb3AuY2hhaW4oZiA9PiBpbmZpeHIocCwgb3ApLmNoYWluKHkgPT4gUGFyc2VyLm9mKGYoeCwgeSkpKSkuYWx0KFBhcnNlci5vZih4KSkpO1xufSJdfQ==